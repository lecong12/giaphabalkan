<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - V94 (Logic Chuẩn)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #fff; }
        #tree { width: 100%; height: 100%; }
        .bft-license-message { display: none !important; }
    </style>
</head>
<body>
<div id="tree"></div>
<script>
    const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
    const url1 = `https://docs.google.com/spreadsheets/d/${ssId}/export?format=csv&gid=0`; 
    const url2 = `https://docs.google.com/spreadsheets/d/${ssId}/export?format=csv&gid=1705210560`;

    async function start() {
        const fetchCSV = (url) => new Promise(r => Papa.parse(url, {download:true, header:true, skipEmptyLines:true, complete:r}));
        
        try {
            const [res1, res2] = await Promise.all([fetchCSV(url1), fetchCSV(url2)]);
            const s = (v) => v ? String(v).trim() : null;

            // 1. Xử lý bảng dData (Dâu/Rể)
            // Lưu lại danh sách vợ/chồng để gắn vào người ở bảng Data
            let partnerMapping = {}; 
            let spouses = res2.data.map(row => {
                const myId = s(row.id);
                const husbandId = s(row.pid); // Cột pid trỏ về ông Mao hoặc người ở bảng Data
                
                if (husbandId) {
                    if (!partnerMapping[husbandId]) partnerMapping[husbandId] = [];
                    partnerMapping[husbandId].push(myId);
                }

                return {
                    id: myId,
                    pids: husbandId ? [husbandId] : [],
                    name: row.full_name,
                    gender: (row.gender || "").toLowerCase().includes('f') ? "female" : "male"
                };
            }).filter(n => n.id);

            // 2. Xử lý bảng Data (Thành viên chính)
            let members = res1.data.map(row => {
                const myId = s(row.id);
                return {
                    id: myId,
                    fid: s(row.fid),
                    mid: s(row.mid), // Gọi ID từ bảng dData (ví dụ: 5001)
                    pids: partnerMapping[myId] || [], // Tự động lấy vợ từ dData
                    name: row.full_name,
                    gender: (row.gender || "").toLowerCase().includes('f') ? "female" : "male"
                };
            }).filter(n => n.id);

            // 3. Gộp tất cả các Node
            const allNodes = [...members, ...spouses];

            // 4. Khởi tạo cây
            new FamilyTree(document.getElementById("tree"), {
                template: "hugo",
                layout: FamilyTree.mixed,
                nodeBinding: { field_0: "name" },
                nodes: allNodes
            });

        } catch (e) {
            console.error("Lỗi hệ thống: ", e);
        }
    }
    start();
</script>
</body>
</html>
