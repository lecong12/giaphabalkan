<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Bản Quét Sạch</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #fff; }
        #tree { width: 100%; height: 100%; }
        #debug-panel { position: fixed; top: 10px; left: 10px; z-index: 9999; background: #222; color: #0f0; padding: 10px; font-family: monospace; font-size: 11px; border-radius: 5px; max-width: 300px; border: 1px solid #555; }
    </style>
</head>
<body>
    <div id="debug-panel">Đang cưỡng chế đọc dữ liệu...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        const panel = document.getElementById("debug-panel");

        // Hàm bốc dữ liệu bất chấp định dạng
        function pick(cell) {
            if (!cell) return "";
            return (cell.f || cell.v || "").toString().trim();
        }

        // Hàm lọc lấy con số ID đầu tiên trong một chuỗi
        function getNumber(str) {
            if (!str) return null;
            const m = str.match(/\d+/);
            return m ? m : null;
        }

        async function start() {
            try {
                const fetchSheet = async (gid) => {
                    const r = await fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`);
                    const t = await r.text();
                    const j = JSON.parse(t.substring(47, t.length - 2));
                    return j.table.rows;
                };

                panel.innerHTML = "Dòng 1: Đang nạp Sheet...";
                const [rowsData, rowsPartner] = await Promise.all([fetchSheet('0'), fetchSheet('1705210560')]);
                
                let nodes = [];
                let pMap = {};

                // 1. Quét Sheet Vợ/Chồng
                rowsPartner.forEach(row => {
                    if (!row.c) return;
                    let cells = row.c.map(c => pick(c));
                    let id = getNumber(cells); // Cột 1
                    let pid = getNumber(cells); // Cột 2
                    let name = cells || cells;
                    if (id && pid) {
                        nodes.push({ id, pids: [pid], name: name.includes(',') ? name.split(',') : name, gender: "female" });
                        if (!pMap[pid]) pMap[pid] = [];
                        pMap[pid].push(id);
                    }
                });

                // 2. Quét Sheet Huyết thống
                rowsData.forEach((row, i) => {
                    if (i === 0 || !row.c) return;
                    let cells = row.c.map(c => pick(c));
                    let id = getNumber(cells);
                    if (id) {
                        nodes.push({
                            id: id,
                            fid: getNumber(cells),
                            mid: getNumber(cells),
                            pids: pMap[id] || [],
                            name: (cells || cells).includes(',') ? (cells || cells).split(',') : (cells || cells),
                            gender: cells && cells.toLowerCase().includes('nữ') ? "female" : "male"
                        });
                    }
                });

                panel.innerHTML = `Tìm thấy ${nodes.length} người. Đang vẽ...`;
                if (nodes.length > 0) {
                    setTimeout(() => panel.style.display = 'none', 3000);
                    [attachment_0](attachment)
                    new FamilyTree(document.getElementById("tree"), {
                        template: "hugo",
                        layout: FamilyTree.layout.hierarchy,
                        nodeBinding: { field_0: "name", field_1: "id" },
                        nodes: nodes.slice(0, 198)
                    });
                } else {
                    panel.innerHTML = "<b style='color:red'>LỖI: Sheets trả về 0 hàng.</b><br>Hãy mở Sheets -> Tệp -> Chia sẻ -> Phát hành lên web.";
                }

            } catch (e) {
                panel.innerHTML = "Lỗi: " + e.message;
            }
        }
        start();
    </script>
</body>
</html>
