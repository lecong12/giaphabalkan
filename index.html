    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';

        async function fetchSheet(gid) {
            const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
            try {
                const res = await fetch(url);
                const text = await res.text();
                const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+?)\);?\s*$/);
                if (!jsonMatch) return [];
                const data = JSON.parse(jsonMatch);
                const cols = data.table.cols.map(c => (c.label || "").toLowerCase().trim());
                return data.table.rows.map(row => {
                    let obj = {};
                    row.c.forEach((cell, i) => { if (cols[i]) obj[cols[i]] = cell ? String(cell.v).trim() : null; });
                    return obj;
                });
            } catch (e) { return []; }
        }

        async function start() {
            // 1. Tải song song cả 2 sheet
            const [data, dData] = await Promise.all([fetchSheet(0), fetchSheet(1705210560)]);
            
            let allNodes = [];
            let partnerMap = {}; // Lưu trữ mối quan hệ vợ chồng từ sheet dData

            // 2. Xử lý sheet dData (Vợ/Chồng)
            dData.forEach(s => {
                if (s.id && s.pid) {
                    allNodes.push({
                        id: s.id,
                        pids: [s.pid], // Kết nối với ID chồng/vợ ở sheet Data
                        name: s.full_name,
                        gender: "female" // Mặc định dData là vợ
                    });
                    // Lưu lại để tí nữa gán ngược vào chồng/vợ ở sheet Data
                    if (!partnerMap[s.pid]) partnerMap[s.pid] = [];
                    partnerMap[s.pid].push(s.id);
                }
            });

            // 3. Xử lý sheet Data (Huyết thống trực hệ)
            data.forEach(m => {
                if (m.id) {
                    allNodes.push({
                        id: m.id,
                        fid: (m.fid && m.fid !== "0") ? m.fid : null,
                        mid: (m.mid && m.mid !== "0") ? m.mid : null,
                        pids: partnerMap[m.id] || [], // Lấy danh sách vợ/chồng từ map đã tạo ở trên
                        name: m.full_name,
                        gender: (m.gender || "").toLowerCase().includes('f') ? "female" : "male"
                    });
                }
            });

            // 4. Khởi tạo FamilyTree hiển thị toàn bộ
            const family = new FamilyTree(document.getElementById("tree"), {
                template: "hugo",
                layout: FamilyTree.mixed,
                mouseScrol: FamilyTree.action.zoom,
                nodeMenu: { edit: { text: "Sửa" }, details: { text: "Chi tiết" } },
                searchFields: ["name"],
                nodeBinding: { field_0: "name" }
            });

            // Tắt loading và nạp TOÀN BỘ dữ liệu
            document.getElementById("loading").style.display = "none";
            
            // family.load sẽ tự động dựng cây từ mảng allNodes
            family.load(allNodes);

            family.on('search-click', function (sender, nodeId) {
                family.center(nodeId, { zoom: 0.8, smooth: true });
                return false;
            });
        }
        start();
    </script>
