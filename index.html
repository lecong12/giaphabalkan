<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Hệ Thống Trực Tuyến</title>
    <script src="https://cdn.balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f4f7f6; }
        #tree { width: 100%; height: 100%; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; font-family: Arial, sans-serif; background: white; padding: 20px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div id="loading">Đang kết nối thư viện và dữ liệu gia tộc Lê Công...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1mX5C3YiDKb-R1Igweo10NsxCtmxIrG2hlCZM5OlPXEw';

        // Hàm parse CSV thủ công để đảm bảo không lỗi nếu thư viện Balkan chưa load kịp
        function manualParseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].replace(/"/g, "").split(',').map(h => h.trim().toLowerCase());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i]) continue;
                const currentline = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                let obj = {};
                headers.forEach((header, j) => {
                    let val = currentline[j] ? currentline[j].replace(/"/g, "").trim() : "";
                    obj[header] = val;
                });
                data.push(obj);
            }
            return data;
        }

        async function init() {
            // Kiểm tra thư viện balkan đã tải xong chưa
            if (typeof FamilyTree === 'undefined') {
                console.log("Đang đợi thư viện...");
                setTimeout(init, 500);
                return;
            }

            try {
                // Tải dữ liệu từ sheet 'Data' (Sheet chính của bạn)
                const response = await fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&sheet=Data`);
                const text = await response.text();
                const rawData = manualParseCSV(text);

                const finalNodes = rawData.map(p => {
                    if (!p.id) return null;
                    
                    // Theo dữ liệu của bạn: fid là cha, mid là mẹ
                    // Balkan cần pids: [cha_id, me_id] để vẽ nhánh con
                    let pids = [];
                    if (p.fid) pids.push(p.fid);
                    if (p.mid) pids.push(p.mid);

                    return {
                        id: p.id,
                        pids: pids.length > 0 ? pids : null,
                        name: p.full_name || "Thành viên " + p.id,
                        gender: (p.gender && p.gender.toLowerCase().includes('fe')) ? 'female' : 'male'
                    };
                }).filter(n => n !== null);

                document.getElementById('loading').style.display = 'none';

                // Vẽ sơ đồ
                const family = new FamilyTree(document.getElementById("tree"), {
                    template: "tommy",
                    nodeBinding: {
                        field_0: "name"
                    },
                    nodes: finalNodes
                });

            } catch (err) {
                document.getElementById('loading').innerHTML = "Lỗi tải dữ liệu: " + err.message + "<br>Hãy kiểm tra quyền Chia sẻ của Google Sheets.";
            }
        }

        // Khởi chạy khi trang web tải xong
        window.onload = init;
    </script>
</body>
</html>
