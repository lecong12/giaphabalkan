<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Ph·∫£ L√™ C√¥ng - Fix Load</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #fdfdfd; }
        #tree { width: 100%; height: 100%; position: absolute; }
        #status { position: fixed; top: 10px; left: 10px; z-index: 9999; background: #000; color: #0f0; padding: 8px 15px; border-radius: 4px; font-family: monospace; font-size: 12px; border: 1px solid #0f0; }
    </style>
</head>
<body>
    <div id="status">üì° ƒêang k·∫øt n·ªëi m√°y ch·ªß d·ªØ li·ªáu...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        const st = document.getElementById("status");

        // H√†m x·ª≠ l√Ω ID an to√†n: L·∫•y s·ªë ƒë·∫ßu ti√™n tr∆∞·ªõc d·∫•u ph·∫©y
        function toId(v) {
            if (v === null || v === undefined) return null;
            let s = String(v).split(',').replace(/[^\d]/g, '');
            return s || null;
        }

        async function start() {
            try {
                const fetchG = async (gid) => {
                    const r = await fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`);
                    if (!r.ok) throw new Error("Kh√¥ng th·ªÉ k·∫øt n·ªëi Sheets");
                    const t = await r.text();
                    const j = JSON.parse(t.substring(47, t.length - 2));
                    return j.table.rows;
                };

                const [r1, r2] = await Promise.all([fetchG('0'), fetchG('1705210560')]);
                
                let nodes = [];
                let pMap = {};

                // 1. X·ª≠ l√Ω V·ª£/Ch·ªìng
                r2.forEach(row => {
                    if (!row.c || !row.c) return;
                    let val0 = row.c.f || row.c.v;
                    let val1 = row.c?.f || row.c?.v;
                    let id = toId(val0);
                    let pid = toId(val1);
                    if (id && pid) {
                        nodes.push({ id, pids: [pid], name: String(val0).split(',') || "V·ª£", gender: "female" });
                        if (!pMap[pid]) pMap[pid] = []; pMap[pid].push(id);
                    }
                });

                // 2. X·ª≠ l√Ω Huy·∫øt th·ªëng
                r1.forEach((row, i) => {
                    if (i === 0 || !row.c || !row.c) return;
                    let val0 = row.c.f || row.c.v;
                    let id = toId(val0);
                    if (id) {
                        let name = (row.c?.f || row.c?.v || val0).toString().split(',') || val0;
                        nodes.push({
                            id, 
                            fid: toId(row.c?.f || row.c?.v),
                            mid: toId(row.c?.f || row.c?.v),
                            pids: pMap[id] || [],
                            name: String(name).trim(),
                            gender: String(row.c?.v || "").toLowerCase().includes('n·ªØ') ? "female" : "male"
                        });
                    }
                });

                st.innerHTML = `‚úÖ ƒê√£ n·∫°p ${nodes.length} ng∆∞·ªùi.`;
                setTimeout(() => st.style.display = 'none', 3000);

                [attachment_0](attachment)
                new FamilyTree(document.getElementById("tree"), {
                    template: "hugo",
                    layout: FamilyTree.layout.hierarchy,
                    nodeBinding: { field_0: "name", field_1: "id" },
                    nodes: nodes.slice(0, 198)
                });

            } catch (e) {
                st.style.background = "red";
                st.innerHTML = "‚ùå L·ªói: " + e.message + ". H√£y ki·ªÉm tra quy·ªÅn Chia s·∫ª Sheets.";
            }
        }
        start();
    </script>
</body>
</html>
