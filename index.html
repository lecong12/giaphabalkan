    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        
        async function start() {
            try {
                const fetchSheet = async (gid) => {
                    const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    const cols = json.table.cols.map(c => (c.label || "").toLowerCase().trim());
                    return json.table.rows.map(row => {
                        let item = {};
                        row.c.forEach((cell, i) => { if (cols[i]) item[cols[i]] = cell ? String(cell.v) : null; });
                        return item;
                    }).filter(r => r.id);
                };

                // Tải dữ liệu từ 2 Sheet
                const [data, dData] = await Promise.all([fetchSheet('0'), fetchSheet('1705210560')]);
                
                let nodesMap = new Map();

                // 1. Nạp Huyết thống (Sheet Data) vào Map trước
                data.forEach(m => {
                    nodesMap.set(m.id, {
                        id: m.id,
                        fid: (m.fid && m.fid !== "0") ? m.fid : null,
                        mid: (m.mid && m.mid !== "0") ? m.mid : null,
                        pids: [], // Sẽ điền ở bước sau
                        name: m.full_name || "Thành viên",
                        gender: (m.gender && m.gender.toLowerCase().includes('f')) ? "female" : "male"
                    });
                });

                // 2. Nạp Vợ/Chồng (Sheet dData) và tạo mối liên kết 2 chiều (Nối dây)
                dData.forEach(p => {
                    if (p.id && p.pid) {
                        // Thêm người vợ/chồng vào danh sách node
                        nodesMap.set(p.id, {
                            id: p.id,
                            pids: [p.pid], // Trỏ về chồng/vợ
                            name: p.full_name || "Vợ/Chồng",
                            gender: "female" // Thường dData là vợ
                        });

                        // CẬP NHẬT NGƯỢC: Tìm người chồng/vợ trong huyết thống để nối dây lại
                        if (nodesMap.has(p.pid)) {
                            let partner = nodesMap.get(p.pid);
                            if (!partner.pids.includes(p.id)) {
                                partner.pids.push(p.id);
                            }
                        }
                    }
                });

                // 3. Chuyển Map thành mảng và LÁCH LUẬT 200 NODES
                // Lưu ý: Lấy 190 người đầu để chừa chỗ cho các đường nối tự động phát sinh
                let allNodes = Array.from(nodesMap.values());
                const safeNodes = allNodes.slice(0, 190);

                document.getElementById("loading").style.display = "none";

                const family = new FamilyTree(document.getElementById("tree"), {
                    mouseScrol: FamilyTree.action.zoom,
                    template: "hugo",
                    nodeBinding: {
                        field_0: "name",
                        field_1: "id"
                    },
                    nodes: safeNodes
                });

            } catch (e) {
                console.error(e);
                document.getElementById("loading").innerText = "Lỗi kết nối: " + e.message;
            }
        }
        start();
    </script>
