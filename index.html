<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - V98</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #eee; }
        #tree { width: 100%; height: 100%; }
        #msg { position: fixed; top: 10px; left: 10px; z-index: 999; background: white; padding: 10px; border: 1px solid #ccc; font-family: sans-serif; }
    </style>
</head>
<body>

<div id="msg">Đang khởi tạo...</div>
<div id="tree"></div>

<script>
    const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
    // Sử dụng đường dẫn tải CSV đơn giản nhất
    const url1 = `https://docs.google.com/spreadsheets/d/${ssId}/export?format=csv&gid=0`;
    const url2 = `https://docs.google.com/spreadsheets/d/${ssId}/export?format=csv&gid=1705210560`;

    async function start() {
        const status = document.getElementById('msg');
        try {
            status.innerHTML = "Đang tải dữ liệu...";
            const fetchCSV = async (url) => {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Không thể truy cập Google Sheets. Hãy kiểm tra quyền Chia sẻ!");
                const txt = await res.text();
                const lines = txt.split('\n').map(l => l.split(',').map(c => c.replace(/"/g, '').trim()));
                const head = lines[0].map(h => h.toLowerCase());
                return lines.slice(1).map(row => {
                    let o = {};
                    head.forEach((h, i) => { if(row[i]) o[h] = row[i]; });
                    return o;
                });
            };

            const [data1, data2] = await Promise.all([fetchCSV(url1), fetchCSV(url2)]);
            status.innerHTML = `Đã nhận: ${data1.length + data2.length} người. Đang vẽ...`;

            // Xử lý quan hệ theo logic của bạn
            let partnersMap = {};
            data2.forEach(s => {
                if(s.pid) {
                    if(!partnersMap[s.pid]) partnersMap[s.pid] = [];
                    partnersMap[s.pid].push(s.id);
                }
            });

            const nodes = [
                ...data1.map(m => ({
                    id: m.id,
                    fid: m.fid || null,
                    mid: m.mid || null,
                    pids: partnersMap[m.id] || [],
                    name: m.full_name,
                    gender: (m.gender || "").toLowerCase().includes('f') ? "female" : "male"
                })),
                ...data2.map(s => ({
                    id: s.id,
                    pids: [s.pid],
                    name: s.full_name,
                    gender: "female"
                }))
            ].filter(n => n.id);

            new FamilyTree(document.getElementById("tree"), {
                template: "hugo",
                nodeBinding: { field_0: "name" },
                nodes: nodes
            });

            status.style.display = "none";

        } catch (e) {
            status.style.color = "red";
            status.innerHTML = "LỖI: " + e.message;
            console.error(e);
        }
    }
    start();
</script>
</body>
</html>
