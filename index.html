<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
        #tree { width: 100%; height: 100%; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; font-family: sans-serif; background: white; padding: 20px; border: 1px solid #b30000; text-align: center; }
    </style>
</head>
<body>
    <div id="loading">Đang kết nối dữ liệu trực tiếp...</div>
    <div id="tree"></div>

    <script>
        // Cấu hình ID Sheet của bạn
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        
        async function start() {
            try {
                // 1. Hàm lấy dữ liệu thô cực kỳ đơn giản
                const fetchRaw = async (gid) => {
                    const res = await fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`);
                    const text = await res.text();
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    return json.table.rows;
                };

                // Tải song song 2 sheet
                const [dataRows, dDataRows] = await Promise.all([fetchRaw('0'), fetchRaw('1705210560')]);
                
                let nodes = [];
                let partnerMap = {};

                // 2. Xử lý Phối ngẫu (Sheet dData) trước để lấy pids
                dDataRows.forEach(row => {
                    const c = row.c;
                    const id = c ? String(c.v) : null;
                    const pid = c ? String(c.v) : null;
                    const name = c ? String(c.v) : (c ? String(c.v) : "Phối ngẫu");
                    
                    if (id && pid) {
                        nodes.push({ id: id, pids: [pid], name: name, gender: "female" });
                        if (!partnerMap[pid]) partnerMap[pid] = [];
                        partnerMap[pid].push(id);
                    }
                });

                // 3. Xử lý Huyết thống (Sheet Data)
                dataRows.forEach(row => {
                    const c = row.c;
                    const id = c ? String(c.v) : null;
                    if (id && id !== "id") {
                        nodes.push({
                            id: id,
                            fid: (c && c.v != 0) ? String(c.v) : null,
                            mid: (c && c.v != 0) ? String(c.v) : null,
                            pids: partnerMap[id] || [],
                            name: c ? String(c.v) : (c ? String(c.v) : "Thành viên"),
                            gender: (c && String(c.v).toLowerCase().includes('f')) ? "female" : "male"
                        });
                    }
                });

                // 4. Lách luật 200 nodes: Chỉ lấy 180 người đầu
                const finalNodes = nodes.slice(0, 185);

                document.getElementById("loading").style.display = "none";

                // Khởi tạo cây
                new FamilyTree(document.getElementById("tree"), {
                    template: "hugo",
                    nodeBinding: { field_0: "name", field_1: "id" },
                    nodes: finalNodes
                });

            } catch (e) {
                document.getElementById("loading").innerHTML = "<b>Lỗi:</b> " + e.message + "<br><small>Hãy kiểm tra quyền chia sẻ Sheet</small>";
                console.error(e);
            }
        }
        start();
    </script>
</body>
</html>
