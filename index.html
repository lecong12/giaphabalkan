<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - V112</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #fdfdfd; font-family: "Segoe UI", Arial, sans-serif; }
        
        .header-container {
            text-align: center;
            padding: 15px 10px;
            background: linear-gradient(to bottom, #b30000, #800000);
            color: #ffd700;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border-bottom: 3px solid #ffd700;
            position: relative;
            z-index: 10;
        }
        .header-container h1 { margin: 0; font-size: 22px; text-transform: uppercase; letter-spacing: 2px; }
        
        /* Tùy chỉnh thanh tìm kiếm cho đẹp hơn */
        .bft-search-container {
            top: 110px !important;
            left: 20px !important;
        }

        #tree { width: 100%; height: calc(100% - 80px); }
        .bft-license-message { display: none !important; }
    </style>
</head>
<body>
    <div class="header-container">
        <h1>Gia Phả Họ Lê Công</h1>
        <p>Hệ thống tìm kiếm thành viên thông minh</p>
    </div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';

        async function fetchSheet(gid) {
            const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
            try {
                const res = await fetch(url);
                const text = await res.text();
                const data = JSON.parse(text.substr(47).slice(0, -2));
                const cols = data.table.cols.map(c => (c.label || "").toLowerCase().trim());
                return data.table.rows.map(row => {
                    let obj = {};
                    row.c.forEach((cell, i) => { if (cols[i]) obj[cols[i]] = cell ? String(cell.v).trim() : null; });
                    return obj;
                });
            } catch (e) { return []; }
        }

        async function start() {
            const [data, dData] = await Promise.all([fetchSheet(0), fetchSheet(1705210560)]);
            let nodes = [];
            let pidsMap = {};

            dData.forEach(s => {
                if (s.id) {
                    nodes.push({ id: s.id, pids: [s.pid], name: s.full_name, gender: "female" });
                    if (s.pid) { if (!pidsMap[s.pid]) pidsMap[s.pid] = []; pidsMap[s.pid].push(s.id); }
                }
            });

            // Giữ dữ liệu fix cứng để bảo vệ các cụ đầu nguồn
            if (!nodes.find(n => n.id == "5001")) {
                nodes.push({ id: "5001", pids: ["1"], name: "Tịnh Bà", gender: "female" });
                if (!pidsMap["1"]) pidsMap["1"] = []; pidsMap["1"].push("5001");
            }
            if (!nodes.find(n => n.id == "5002")) {
                nodes.push({ id: "5002", pids: ["2"], name: "Bùi Thị Việt", gender: "female" });
                if (!pidsMap["2"]) pidsMap["2"] = []; pidsMap["2"].push("5002");
            }

            data.forEach(m => {
                if (m.id) {
                    nodes.push({
                        id: m.id,
                        fid: (m.fid && m.fid !== "0") ? m.fid : null,
                        mid: (m.mid && m.mid !== "0") ? m.mid : (m.id == "2" ? "5001" : null),
                        pids: pidsMap[m.id] || [],
                        name: m.full_name,
                        gender: (m.gender || "").toLowerCase().includes('f') ? "female" : "male"
                    });
                }
            });

            const family = new FamilyTree(document.getElementById("tree"), {
                template: "hugo",
                layout: FamilyTree.mixed,
                // Kích hoạt thanh tìm kiếm
                searchFields: ["name"], 
                nodeBinding: { field_0: "name" },
                nodes: nodes
            });

            // Cấu hình: Khi tìm thấy, tự động nhảy đến và phóng to
            family.on('search-click', function (sender, nodeId) {
                family.center(nodeId, {
                    zoom: 0.8,
                    smooth: true
                });
                return false; // Chặn hành động mặc định để chạy lệnh center mượt hơn
            });
        }
        start();
    </script>
</body>
</html>
