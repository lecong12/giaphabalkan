<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - V97</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #fff; }
        #tree { width: 100%; height: 100%; }
        .bft-license-message { display: none !important; }
    </style>
</head>
<body>
<div id="tree"></div>
<script>
    const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
    const url1 = `https://docs.google.com/spreadsheets/d/${ssId}/export?format=csv&gid=0`; 
    const url2 = `https://docs.google.com/spreadsheets/d/${ssId}/export?format=csv&gid=1705210560`;

    // Hàm đọc CSV "siêu sạch" - Loại bỏ mọi lỗi định dạng của Google
    async function getData(url) {
        const res = await fetch(url);
        const text = await res.text();
        const rows = text.split(/\r?\n/).map(row => {
            // Tách cột bằng dấu phẩy, xử lý cả trường hợp nội dung có dấu phẩy bên trong ngoặc kép
            return row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell.replace(/^"|"$/g, '').trim());
        });
        const headers = rows[0].map(h => h.toLowerCase());
        return rows.slice(1).map(row => {
            let obj = {};
            headers.forEach((h, i) => { if (row[i]) obj[h] = row[i]; });
            return obj;
        }).filter(o => o.id);
    }

    async function start() {
        try {
            const [data, dData] = await Promise.all([getData(url1), getData(url2)]);

            // 1. Tạo bản đồ Vợ/Chồng (pids)
            let pidsMap = {};
            dData.forEach(row => {
                const myId = row.id;
                const husId = row.pid;
                if (myId && husId) {
                    if (!pidsMap[husId]) pidsMap[husId] = [];
                    pidsMap[husId].push(myId);
                }
            });

            // 2. Gộp dữ liệu Thành viên + Dâu rể
            let allNodes = [];

            // Add người trong tộc
            data.forEach(m => {
                allNodes.push({
                    id: m.id,
                    fid: m.fid || null,
                    mid: m.mid || null,
                    pids: pidsMap[m.id] || [],
                    name: m.full_name || "Vô danh",
                    gender: (m.gender || "").toLowerCase().includes('f') ? "female" : "male"
                });
            });

            // Add dâu rể
            dData.forEach(s => {
                allNodes.push({
                    id: s.id,
                    pids: [s.pid],
                    name: s.full_name || "Vợ/Chồng",
                    gender: "female"
                });
            });

            // 3. Kiểm tra tính tồn tại của Cha/Mẹ để tránh "treo" cây
            const validIds = new Set(allNodes.map(n => n.id));
            allNodes.forEach(n => {
                if (n.fid && !validIds.has(n.fid)) n.fid = null;
                if (n.mid && !validIds.has(n.mid)) n.mid = null;
            });

            // 4. Vẽ cây
            new FamilyTree(document.getElementById("tree"), {
                template: "hugo",
                nodeBinding: { field_0: "name" },
                nodes: allNodes
            });

        } catch (e) {
            console.error(e);
            document.body.innerHTML = "<div style='padding:20px'>Đã xảy ra lỗi nạp dữ liệu. Vui lòng kiểm tra quyền chia sẻ file Google Sheets!</div>";
        }
    }
    start();
</script>
</body>
</html>
