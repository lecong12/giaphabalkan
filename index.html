    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';

        async function fetchSheet(gid) {
            const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
            try {
                const res = await fetch(url);
                const text = await res.text();
                const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+?)\);?\s*$/);
                if (!jsonMatch) return [];
                const data = JSON.parse(jsonMatch);
                const cols = data.table.cols.map(c => (c.label || "").toLowerCase().trim());
                
                return data.table.rows
                    .map(row => {
                        let obj = {};
                        row.c.forEach((cell, i) => { 
                            if (cols[i]) obj[cols[i]] = (cell && cell.v !== null) ? String(cell.v).trim() : null; 
                        });
                        return obj;
                    })
                    .filter(item => item.id && item.id !== "null"); // Loại bỏ dòng trống không có ID
            } catch (e) { 
                console.error("Lỗi fetch GID " + gid, e);
                return []; 
            }
        }

        async function start() {
            try {
                const [raw_data, raw_dData] = await Promise.all([fetchSheet(0), fetchSheet(1705210560)]);
                
                let allNodes = [];
                let partnerMap = {};

                // 1. Xử lý Vợ/Chồng (dData) trước
                raw_dData.forEach(s => {
                    if (s.id && s.pid) {
                        allNodes.push({
                            id: s.id,
                            pids: [s.pid],
                            name: s.full_name || "Chưa rõ tên",
                            gender: "female"
                        });
                        if (!partnerMap[s.pid]) partnerMap[s.pid] = [];
                        partnerMap[s.pid].push(s.id);
                    }
                });

                // 2. Xử lý Huyết thống (Data)
                raw_data.forEach(m => {
                    if (m.id) {
                        // Kiểm tra tránh trùng ID nếu lỡ sheet dData cũng có ID đó
                        if (allNodes.find(n => n.id === m.id)) return; 

                        allNodes.push({
                            id: m.id,
                            fid: (m.fid && m.fid !== "0") ? m.fid : null,
                            mid: (m.mid && m.mid !== "0") ? m.mid : null,
                            pids: partnerMap[m.id] || [],
                            name: m.full_name || "Chưa rõ tên",
                            gender: (m.gender || "").toLowerCase().includes('f') ? "female" : "male"
                        });
                    }
                });

                // 3. Kiểm tra xem có dữ liệu không trước khi nạp
                if (allNodes.length === 0) {
                    document.getElementById("loading").innerText = "Không lấy được dữ liệu. Kiểm tra quyền chia sẻ Sheet!";
                    return;
                }

                const family = new FamilyTree(document.getElementById("tree"), {
                    template: "hugo",
                    layout: FamilyTree.mixed,
                    mouseScrol: FamilyTree.action.zoom,
                    searchFields: ["name"],
                    nodeBinding: { field_0: "name" },
                    nodes: allNodes // Nạp trực tiếp tại đây cho chắc chắn
                });

                document.getElementById("loading").style.display = "none";
                console.log("Đã nạp tổng cộng: " + allNodes.length + " thành viên.");

            } catch (err) {
                console.error("Lỗi hệ thống:", err);
                document.getElementById("loading").innerText = "Lỗi xử lý dữ liệu: " + err.message;
            }
        }
        start();
    </script>
