<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Ph·∫£ L√™ C√¥ng - Radar Check</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #fff; }
        #tree { width: 100%; height: 100%; position: absolute; }
        #log { position: fixed; bottom: 10px; left: 10px; z-index: 999; background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 11px; border: 1px solid #0f0; }
    </style>
</head>
<body>
    <div id="log">üì° ƒêang qu√©t d·ªØ li·ªáu...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        const log = document.getElementById("log");

        // H√†m b√≥c s·ªë ID d√π d·ªØ li·ªáu nh·∫£y ki·ªÉu g√¨
        function toId(v) {
            if (!v) return null;
            let s = String(v).split(',');
            let id = s.replace(/\D/g, ''); // Ch·ªâ l·∫•y s·ªë
            return id || null;
        }

        async function start() {
            try {
                const fetchG = async (gid) => {
                    const r = await fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`);
                    const t = await r.text();
                    const j = JSON.parse(t.substring(47, t.length - 2));
                    return j.table.rows;
                };

                log.innerHTML += "<br>1. ƒêang g·ªçi Google Sheets...";
                const [r1, r2] = await Promise.all([fetchG('0'), fetchG('1705210560')]);
                
                let nodes = [];
                let pMap = {};

                // Qu√©t ph·ªëi ng·∫´u
                r2.forEach(row => {
                    if (!row.c || !row.c) return;
                    let id = toId(row.c.f || row.c.v);
                    let pid = toId(row.c?.f || row.c?.v);
                    if (id && pid) {
                        nodes.push({ id, pids: [pid], name: "V·ª£", gender: "female" });
                        if (!pMap[pid]) pMap[pid] = []; pMap[pid].push(id);
                    }
                });

                // Qu√©t huy·∫øt th·ªëng
                r1.forEach((row, i) => {
                    if (i === 0 || !row.c || !row.c) return;
                    let raw = row.c.f || row.c.v;
                    let id = toId(raw);
                    if (id) {
                        let name = (row.c?.f || row.c?.v || raw).toString().split(',') || raw;
                        nodes.push({
                            id, 
                            fid: toId(row.c?.f || row.c?.v),
                            mid: toId(row.c?.f || row.c?.v),
                            pids: pMap[id] || [],
                            name: name.trim(),
                            gender: String(row.c?.v || "").toLowerCase().includes('n·ªØ') ? "female" : "male"
                        });
                    }
                });

                log.innerHTML = `‚úÖ Th√†nh c√¥ng! ƒê√£ n·∫°p ${nodes.length} ng∆∞·ªùi.`;
                if (nodes.length > 0) {
                    setTimeout(() => log.style.display = 'none', 5000);
                    [attachment_0](attachment)
                    new FamilyTree(document.getElementById("tree"), {
                        template: "hugo",
                        layout: FamilyTree.layout.hierarchy,
                        nodeBinding: { field_0: "name", field_1: "id" },
                        nodes: nodes.slice(0, 198)
                    });
                } else {
                    log.innerHTML = "‚ùå L·ªñI: Sheets tr·∫£ v·ªÅ h√†ng tr·ªëng!";
                }
            } catch (e) {
                log.innerHTML = "‚ùå L·ªói k·∫øt n·ªëi: H√£y ki·ªÉm tra quy·ªÅn Chia s·∫ª Sheets.";
            }
        }
        start();
    </script>
</body>
</html>
