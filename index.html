<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Bản V66</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/treant-js/1.0/Treant.css">
    <style>
        html, body { width: 100%; height: 100%; margin: 0; background: #fff; }
        .chart { height: 100%; width: 100%; }
        .node { padding: 10px; border: 2px solid #007bff; border-radius: 5px; background: #f9f9f9; width: 150px; }
        .node p { margin: 0; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="chart" id="tree-simple"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/treant-js/1.0/Treant.min.js"></script>

    <script>
        const SHEET_ID = '19ON0r9hn0Z6VcuM9oeeKyaCP863tkZlqeV3Si3v25KE';
        const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Data`;

        async function init() {
            try {
                const res = await fetch(URL);
                const text = await res.text();
                const lines = text.split('\n').slice(1);
                
                const nodesMap = {};
                const treeData = { chart: { container: "#tree-simple", connecters: { type: "step" } }, nodeStructure: null };

                const rawNodes = lines.map(line => {
                    const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    const id = cols[0]?.replace(/"/g, "").trim();
                    const fid = cols[1]?.replace(/"/g, "").trim();
                    return {
                        id: id,
                        parentId: (fid === "0" || fid === "") ? null : fid,
                        text: { name: cols[3]?.replace(/"/g, "").trim() || "Chưa rõ" }
                    };
                }).filter(n => n.id);

                // Tạo Map để truy xuất nhanh
                rawNodes.forEach(n => { nodesMap[n.id] = { ...n, children: [] }; });

                let root = null;
                rawNodes.forEach(n => {
                    if (n.parentId && nodesMap[n.parentId]) {
                        nodesMap[n.parentId].children.push(nodesMap[n.id]);
                    } else if (!root) {
                        root = nodesMap[n.id]; // Lấy người đầu tiên không cha làm gốc
                    }
                });

                treeData.nodeStructure = root;
                new Treant(treeData);

            } catch (e) {
                console.error(e);
                document.body.innerHTML = "Có lỗi xảy ra khi xử lý dữ liệu. Kiểm tra bảng tính.";
            }
        }
        init();
    </script>
</body>
</html>
