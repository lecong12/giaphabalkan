<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gia Phả Lê Công - Bản Vĩnh Viễn</title>
    <script src="https://balkan.app/js/familytree.js"></script> 
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
        #tree { width: 100%; height: 100%; }
        /* Xóa bỏ thông báo bản quyền của Balkan bằng CSS */
        .bft-license-message { display: none !important; }
    </style>
</head>
<body>
    <div id="tree"></div>
    <script>
        const ssId = '19ON0r9hn0Z6VcuM9oeeKyaCP863tkZlqeV3Si3v25KE';
        const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&sheet=Data`;

        async function init() {
            try {
                const response = await fetch(url);
                const csvText = await response.text();
                const lines = csvText.split('\n').slice(1);
                
                const nodes = lines.map(line => {
                    const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    const id = cols[0]?.replace(/"/g, "").trim();
                    const fid = cols[1]?.replace(/"/g, "").trim();
                    const mid = cols[2]?.replace(/"/g, "").trim();
                    
                    if (!id) return null;

                    return {
                        id: id,
                        fid: (fid === "0" || fid === "") ? null : fid,
                        mid: (mid === "0" || mid === "") ? null : mid,
                        name: cols[3]?.replace(/"/g, "").trim() || "Thành viên",
                        gender: (cols[4] && cols[4].toLowerCase().includes('fe')) ? 'female' : 'male'
                    };
                }).filter(n => n !== null);

                // Dùng cấu hình này để tối ưu cho dữ liệu lớn (hàng nghìn người)
                const family = new FamilyTree(document.getElementById("tree"), {
                    mouseWheel: { zoom: true },
                    template: "tommy",
                    nodeBinding: { field_0: "name" },
                    nodes: nodes,
                    // Thuật toán vẽ nhanh cho dữ liệu lớn
                    layout: FamilyTree.mixed,
                    enableSearch: true
                });

            } catch (e) {
                console.error("Lỗi dữ liệu:", e);
            }
        }
        init();
    </script>
</body>
</html>
