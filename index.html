<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - V83 (Final Fix)</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #fff; font-family: sans-serif; }
        #tree { width: 100%; height: 100%; }
        #debug { position: fixed; top: 0; left: 0; width: 100%; background: #000; color: #0f0; z-index: 9999; font-size: 10px; max-height: 150px; overflow: auto; padding: 5px; }
        .bft-license-message { display: none !important; }
    </style>
</head>
<body>

<div id="debug">Đang kiểm tra kết nối...</div>
<div id="tree"></div>

<script>
    const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
    
    // Ép buộc lấy đúng GID (Trang chứa dữ liệu của bạn)
    const urlData = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&gid=0`; 
    const urldData = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&gid=1705210560`;

    function log(m) { document.getElementById('debug').innerHTML += "<br>" + m; }

    async function loadSheet(url) {
        const res = await fetch(url);
        const text = await res.text();
        // Tách dòng và xử lý dấu phẩy
        return text.split('\n').map(line => {
            return line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(item => item.replace(/"/g, '').trim());
        });
    }

    async function start() {
        try {
            log("Đang tải dữ liệu...");
            const [rows1, rows2] = await Promise.all([loadSheet(urlData), loadSheet(urldData)]);
            
            log("Data nhận được: " + rows1.length + " hàng. dData nhận được: " + rows2.length + " hàng.");

            // Hàm map dữ liệu dựa trên tiêu đề (Bất kể thứ tự cột)
            function mapData(rows) {
                const head = rows[0].map(h => h.toLowerCase());
                log("Cột tìm thấy: " + head.join(" | "));
                
                return rows.slice(1).map(row => {
                    let obj = {};
                    head.forEach((h, i) => obj[h] = row[i]);
                    if (!obj.id) return null;
                    return {
                        id: obj.id,
                        pids: obj.pid ? [obj.pid] : [],
                        fid: obj.fid || null,
                        mid: obj.mid || null,
                        name: obj.full_name || "Lỗi Tên",
                        gender: (obj.gender || "").toLowerCase().includes('f') ? "female" : "male"
                    };
                }).filter(n => n !== null);
            }

            const members = mapData(rows1);
            const spouses = mapData(rows2);

            // Đồng bộ pids (kết nối hôn nhân 2 chiều)
            let partnerMap = {};
            spouses.forEach(s => { if(s.pids[0]) { if(!partnerMap[s.pids[0]]) partnerMap[s.pids[0]] = []; partnerMap[s.pids[0]].push(s.id); }});
            members.forEach(m => { if(partnerMap[m.id]) m.pids = partnerMap[m.id]; });

            log("Đang vẽ cây với " + (members.length + spouses.length) + " người...");

            new FamilyTree(document.getElementById("tree"), {
                template: "tommy",
                nodeBinding: { field_0: "name" },
                nodes: [...members, ...spouses]
            });

            setTimeout(() => document.getElementById('debug').style.display = 'none', 5000);

        } catch (e) {
            log("LỖI CỰC NẶNG: " + e.message);
        }
    }

    start();
</script>
</body>
</html>
