<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
        #tree { width: 100%; height: 100%; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="loading">Đang tải dữ liệu từ Google Sheets...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        // GID 0 là sheet Data, GID 1705210560 là sheet dData
        const gids = ['0', '1705210560']; 

        async function fetchData() {
            try {
                let allRows = [];
                
                for (let gid of gids) {
                    const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    
                    const cols = json.table.cols.map(c => (c.label || "").toLowerCase().trim());
                    const rows = json.table.rows.map(row => {
                        let item = {};
                        row.c.forEach((cell, i) => {
                            if (cols[i]) item[cols[i]] = cell ? String(cell.v) : null;
                        });
                        return item;
                    });
                    allRows = allRows.concat(rows);
                }

                // Chuyển đổi sang định dạng Balkan FamilyTree
                const nodes = allRows.filter(r => r.id).map(r => {
                    return {
                        id: r.id,
                        pids: r.pid ? [r.pid] : (r.pids ? r.pids.split(',') : []),
                        mid: (r.mid && r.mid !== "0") ? r.mid : null,
                        fid: (r.fid && r.fid !== "0") ? r.fid : null,
                        name: r.full_name || r.name || "Thành viên",
                        gender: (r.gender && r.gender.toLowerCase().includes('f')) ? "female" : "male"
                    };
                });

                document.getElementById("loading").style.display = "none";

                const family = new FamilyTree(document.getElementById("tree"), {
                    mouseScrol: FamilyTree.action.zoom,
                    nodeBinding: { field_0: "name" },
                    nodes: nodes
                });

            } catch (e) {
                console.error(e);
                document.getElementById("loading").innerText = "Lỗi: " + e.message + ". Hãy kiểm tra Console (F12).";
            }
        }

        fetchData();
    </script>
</body>
</html>
