<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #ffffff; }
        #tree { width: 100%; height: 100%; }
        #status { position: fixed; bottom: 20px; left: 20px; z-index: 999; background: rgba(0,0,0,0.8); color: #fff; padding: 10px; font-family: monospace; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="status">Khởi tạo...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        const status = document.getElementById("status");

        // Hàm lấy số ID: Lấy tất cả chữ số từ đầu chuỗi cho đến khi gặp ký tự khác
        function parseId(val) {
            if (!val) return null;
            const match = String(val).match(/^\d+/);
            return match ? match : null;
        }

        // Hàm lấy Tên: Lấy phần sau dấu phẩy, nếu không có thì lấy hết
        function parseName(val) {
            if (!val) return "";
            const s = String(val);
            return s.includes(',') ? s.split(',').slice(1).join(',').trim() : s;
        }

        async function start() {
            try {
                const fetchSheet = async (gid) => {
                    const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    
                    // Lấy 'f' (giá trị hiển thị) nếu 'v' (giá trị thô) bị lỗi
                    return json.table.rows.map(row => 
                        row.c.map(cell => cell ? (cell.f || cell.v || "") : "")
                    );
                };

                status.innerText = "Đang đọc dữ liệu...";
                const [dataRows, dDataRows] = await Promise.all([fetchSheet('0'), fetchSheet('1705210560')]);
                
                let nodesMap = {};
                let partnerMap = {}; 

                // 1. Sheet dData (Vợ/Chồng)
                dDataRows.forEach((r, i) => {
                    if (i === 0) return;
                    const id = parseId(r);
                    const pid = parseId(r);
                    if (id && pid) {
                        nodesMap[id] = { id, pids: [pid], name: parseName(r || r), gender: "female" };
                        if (!partnerMap[pid]) partnerMap[pid] = [];
                        partnerMap[pid].push(id);
                    }
                });

                // 2. Sheet Data (Huyết thống)
                dataRows.forEach((r, i) => {
                    if (i === 0) return;
                    const id = parseId(r);
                    if (id) {
                        nodesMap[id] = {
                            id,
                            fid: parseId(r),
                            mid: parseId(r),
                            pids: partnerMap[id] || [],
                            name: parseName(r || r),
                            gender: String(r).toLowerCase().includes('nữ') ? "female" : "male"
                        };
                    }
                });

                const nodes = Object.values(nodesMap).slice(0, 195);
                status.innerText = `Tìm thấy ${nodes.length} người. Đang vẽ...`;

                if (nodes.length > 0) {
                    new FamilyTree(document.getElementById("tree"), {
                        template: "hugo",
                        layout: FamilyTree.layout.hierarchy,
                        nodeBinding: { field_0: "name", field_1: "id" },
                        nodes: nodes
                    });
                    setTimeout(() => status.style.display = "none", 3000);
                } else {
                    status.innerText = "LỖI: Không bóc tách được ID nào!";
                }

            } catch (e) {
                status.innerText = "Lỗi: " + e.message;
            }
        }
        start();
    </script>
</body>
</html>
