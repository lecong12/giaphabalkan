<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Bản Hoàn Thiện</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #f0f2f5; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
        #tree { width: 100%; height: 100%; }
        /* Ẩn dòng chữ quảng cáo của thư viện */
        .bft-license-message { display: none !important; }
    </style>
</head>
<body>
<div id="tree"></div>
<script>
    const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
    const urlData = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&gid=0`; 
    const urldData = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&gid=1705210560`;

    async function start() {
        const fetchCSV = (url) => new Promise(r => Papa.parse(url, {download:true, header:true, skipEmptyLines:true, complete:r}));
        
        try {
            const [res1, res2] = await Promise.all([fetchCSV(urlData), fetchCSV(urldData)]);
            
            // Hàm xử lý dữ liệu và làm sạch tên cột
            const process = (data) => data.map(row => {
                let n = {};
                for (let k in row) n[k.toLowerCase().trim()] = row[k];
                return n;
            }).filter(p => p.id);

            let members = process(res1.data);
            let spouses = process(res2.data);

            // Tạo bản đồ mai mối
            let partnerMap = {};
            spouses.forEach(s => {
                if(s.pid) {
                    if(!partnerMap[s.pid]) partnerMap[s.pid] = [];
                    partnerMap[s.pid].push(s.id);
                }
            });

            // Gộp và chuẩn hóa Node cho Balkan
            const allNodes = [
                ...members.map(m => ({
                    id: m.id,
                    fid: m.fid || null,
                    mid: m.mid || null,
                    pids: partnerMap[m.id] || [],
                    name: m.full_name,
                    gender: (m.gender || "").toLowerCase().includes('f') ? "female" : "male",
                    title: m.address || ""
                })),
                ...spouses.map(s => ({
                    id: s.id,
                    pids: [s.pid],
                    name: s.full_name,
                    gender: (s.gender || "").toLowerCase().includes('f') ? "female" : "male",
                    title: s.address || ""
                }))
            ];

            // Cấu hình vẽ cây ĐẸP
            new FamilyTree(document.getElementById("tree"), {
                mouseWheel: { zoom: true },
                template: "hugo", // Đổi sang Hugo để nhìn hiện đại hơn tommy
                mode: 'dark',
                enableSearch: true,
                siblingSeparation: 100, // Tăng khoảng cách giữa các anh em
                levelSeparation: 150,   // Tăng khoảng cách giữa các thế hệ
                nodeBinding: {
                    field_0: "name",
                    field_1: "title"
                },
                nodes: allNodes
            });

        } catch (e) { console.error("Lỗi:", e); }
    }
    start();
</script>
</body>
</html>
