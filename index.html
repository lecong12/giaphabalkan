<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gia Phả Lê Công - Hệ Thống Trực Tuyến</title>
    <script src="https://balkan.app/js/FamilyTree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
        #tree { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        /* Hiệu ứng loading giống Xtea */
        #loader {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px; background: rgba(255,255,255,0.9); border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 10;
        }
    </style>
</head>
<body>
    <div id="loader">Đang khởi tạo cây gia phả Lê Công...</div>
    <div id="tree"></div>

    <script>
        // Link Google Sheets mới bạn đã cung cấp
        const SHEET_ID = '19ON0r9hn0Z6VcuM9oeeKyaCP863tkZlqeV3Si3v25KE';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Data`;

        // Hàm làm sạch dữ liệu
        const clean = (v) => v ? v.replace(/"/g, "").trim() : "";

        async function drawTree() {
            try {
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                
                // Tách dòng và xử lý tiêu đề
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => clean(h).toLowerCase());
                
                const nodes = [];
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    let row = {};
                    headers.forEach((h, index) => { row[h] = clean(cols[index]); });

                    if (row.id) {
                        nodes.push({
                            id: row.id,
                            fid: (row.fid && row.fid !== "0") ? row.fid : null,
                            mid: (row.mid && row.mid !== "0") ? row.mid : null,
                            name: row.full_name || "Thành viên " + row.id,
                            gender: (row.gender && row.gender.toLowerCase().includes('fe')) ? 'female' : 'male',
                            address: row.adress || "",
                            note: row.notes || ""
                        });
                    }
                }

                document.getElementById('loader').style.display = 'none';

                // Khởi tạo Balkan FamilyTree
                const family = new FamilyTree(document.getElementById("tree"), {
                    mouseWheel: { zoom: true },
                    template: "tommy",
                    nodeBinding: {
                        field_0: "name",
                        field_1: "address"
                    },
                    enableSearch: true,
                    layout: FamilyTree.mixed,
                    nodes: nodes
                });

            } catch (err) {
                document.getElementById('loader').innerHTML = "Lỗi tải dữ liệu. Hãy đảm bảo Sheets đã được chia sẻ công khai.";
            }
        }

        window.onload = drawTree;
    </script>
</body>
</html>
