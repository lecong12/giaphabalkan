<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - V82 (Fix Vô Danh)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #fff; }
        #tree { width: 100%; height: 100%; }
        .bft-license-message { display: none !important; }
    </style>
</head>
<body>
<div id="tree"></div>
<script>
    const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
    // Sử dụng link export đơn giản nhất
    const urlData = `https://docs.google.com/spreadsheets/d/${ssId}/export?format=csv&sheet=Data`;
    const urldData = `https://docs.google.com/spreadsheets/d/${ssId}/export?format=csv&sheet=dData`;

    async function start() {
        const fetchCSV = (url) => new Promise(r => Papa.parse(url, {download:true, complete:r}));
        
        try {
            const [res1, res2] = await Promise.all([fetchCSV(urlData), fetchCSV(urldData)]);
            
            // Hàm lấy dữ liệu theo VỊ TRÍ CỘT (Không quan tâm tên tiêu đề)
            // Giả định: Cột 0=id, Cột 1=full_name, Cột 2=gender, Cột 3=fid/pid, Cột 4=mid
            const parseRows = (rows, isSpouse = false) => {
                return rows.slice(1).map(row => { // Bỏ qua hàng tiêu đề
                    const id = String(row[0] || "").trim();
                    if (!id) return null;

                    let node = {
                        id: id,
                        name: String(row[1] || "").trim() || "ID: " + id,
                        gender: String(row[2] || "").toLowerCase().includes("f") ? "female" : "male"
                    };

                    if (isSpouse) {
                        node.pids = [String(row[3] || "").trim()]; // pid ở cột D
                    } else {
                        node.fid = String(row[3] || "").trim() || null; // fid ở cột D
                        node.mid = String(row[4] || "").trim() || null; // mid ở cột E
                    }
                    return node;
                }).filter(n => n !== null);
            };

            let nodesMembers = parseRows(res1.data, false);
            let nodesSpouses = parseRows(res2.data, true);

            // Tự động kết nối ngược từ Chồng sang Vợ (pids hai chiều)
            let spouseLinks = {};
            nodesSpouses.forEach(s => {
                if (s.pids[0]) {
                    if (!spouseLinks[s.pids[0]]) spouseLinks[s.pids[0]] = [];
                    spouseLinks[s.pids[0]].push(s.id);
                }
            });

            nodesMembers.forEach(m => {
                if (spouseLinks[m.id]) m.pids = spouseLinks[m.id];
            });

            new FamilyTree(document.getElementById("tree"), {
                template: "tommy",
                nodeBinding: { field_0: "name" },
                nodes: [...nodesMembers, ...nodesSpouses]
            });

        } catch (e) { console.error(e); }
    }
    start();
</script>
</body>
</html>
