<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - V107</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #fff; }
        #tree { width: 100%; height: 100%; }
        .bft-license-message { display: none !important; }
    </style>
</head>
<body>
    <div id="tree"></div>
    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';

        async function fetchSheet(gid) {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
                const res = await fetch(url);
                const text = await res.text();
                const data = JSON.parse(text.substr(47).slice(0, -2));
                const cols = data.table.cols.map(c => (c.label || "").toLowerCase().trim());
                return data.table.rows.map(row => {
                    let obj = {};
                    row.c.forEach((cell, i) => { 
                        if (cols[i]) {
                            let val = cell ? cell.v : null;
                            obj[cols[i]] = val !== null ? String(val).trim() : null;
                        }
                    });
                    return obj;
                });
            } catch (e) { return []; } // Nếu lỗi sheet thì trả về mảng rỗng
        }

        async function start() {
            // Tải dữ liệu (Sheet Data: 0, Sheet dData: 1705210560)
            const [members, spouses] = await Promise.all([fetchSheet(0), fetchSheet(1705210560)]);
            
            let nodes = [];
            let spouseMap = {};

            // 1. Thu thập dữ liệu vợ từ sheet dData (nếu có)
            spouses.forEach(s => {
                if (s.id && s.pid) {
                    if (!spouseMap[s.pid]) spouseMap[s.pid] = [];
                    spouseMap[s.pid].push(s.id);
                    nodes.push({
                        id: s.id,
                        pids: [s.pid],
                        name: s.full_name || "Bà",
                        gender: "female"
                    });
                }
            });

            // 2. Thu thập dữ liệu thành viên từ sheet Data
            members.forEach(m => {
                if (m.id) {
                    nodes.push({
                        id: m.id,
                        fid: (m.fid && m.fid !== "0") ? m.fid : null,
                        mid: (m.mid && m.mid !== "0") ? m.mid : null,
                        pids: spouseMap[m.id] || [],
                        name: m.full_name || "Vô danh",
                        gender: (m.gender || "").toLowerCase().includes('f') ? "female" : "male"
                    });
                }
            });

            // 3. Hiển thị cây (Nếu nodes trống sẽ không bị lỗi màn hình trắng)
            if (nodes.length > 0) {
                new FamilyTree(document.getElementById("tree"), {
                    template: "hugo",
                    layout: FamilyTree.mixed,
                    nodeBinding: { field_0: "name" },
                    nodes: nodes
                });
            } else {
                document.body.innerHTML = "<h3>Đang tải hoặc không tìm thấy dữ liệu. Kiểm tra lại ID Sheet.</h3>";
            }
        }
        start();
    </script>
</body>
</html>
