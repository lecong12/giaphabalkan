<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Bản Chống Sập</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #ffffff; }
        #tree { width: 100%; height: 100%; }
        #status { position: fixed; top: 10px; left: 10px; z-index: 9999; background: #b30000; color: #fff; padding: 10px 20px; border-radius: 5px; font-family: Arial, sans-serif; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div id="status">Đang cưỡng chế nạp dữ liệu...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';

        // HÀM XỬ LÝ ID TUYỆT ĐỐI AN TOÀN
        function forceGetId(val) {
            if (val === null || val === undefined) return null;
            
            // Chuyển về chuỗi an toàn nhất có thể
            let s = "";
            try {
                s = val.toString();
            } catch(e) {
                s = String(val);
            }

            if (typeof s !== 'string') return null;

            // Tách dấu phẩy nếu có
            let parts = s.split(',');
            let idPart = parts;

            // Chỉ lấy các con số bằng cách duyệt từng ký tự (không dùng replace để tránh lỗi)
            let cleanId = "";
            for (let i = 0; i < idPart.length; i++) {
                if (idPart[i] >= '0' && idPart[i] <= '9') {
                    cleanId += idPart[i];
                }
            }
            return cleanId.length > 0 ? cleanId : null;
        }

        function forceGetName(val) {
            if (val === null || val === undefined) return "Thành viên";
            try {
                let s = val.toString();
                let parts = s.split(',');
                return parts.length > 1 ? parts.slice(1).join(',').trim() : s.trim();
            } catch(e) {
                return "Thành viên";
            }
        }

        async function start() {
            const statusBox = document.getElementById("status");
            try {
                const fetchSheet = async (gid) => {
                    const res = await fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`);
                    const text = await res.text();
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    return json.table.rows.map(r => r.c ? r.c.map(cell => cell ? cell.v : null) : []);
                };

                const [dataRows, dDataRows] = await Promise.all([fetchSheet('0'), fetchSheet('1705210560')]);
                
                let nodesMap = {};
                let partnerMap = {}; 

                // 1. Xử lý Phối ngẫu
                dDataRows.forEach((r, i) => {
                    if (i === 0 || !r || r.length < 2) return;
                    let id = forceGetId(r);
                    let pid = forceGetId(r);
                    let name = forceGetName(r || r);

                    if (id && pid) {
                        nodesMap[id] = { id: id, pids: [pid], name: name, gender: "female" };
                        if (!partnerMap[pid]) partnerMap[pid] = [];
                        partnerMap[pid].push(id);
                    }
                });

                // 2. Xử lý Huyết thống
                dataRows.forEach((r, i) => {
                    if (i === 0 || !r || r.length < 1) return;
                    let id = forceGetId(r);
                    let fid = forceGetId(r);
                    let mid = forceGetId(r);
                    let name = forceGetName(r || r);
                    
                    let g = "male";
                    try {
                        let gRaw = String(r || "").toLowerCase();
                        if (gRaw.includes('f') || gRaw.includes('nữ')) g = "female";
                    } catch(e) {}

                    if (id) {
                        nodesMap[id] = {
                            id: id,
                            fid: (fid !== id) ? fid : null,
                            mid: mid,
                            pids: partnerMap[id] || [],
                            name: name,
                            gender: g
                        };
                    }
                });

                statusBox.style.display = "none";

                // 3. Khởi tạo cây
                new FamilyTree(document.getElementById("tree"), {
                    mouseScrol: FamilyTree.action.zoom,
                    template: "hugo",
                    layout: FamilyTree.layout.hierarchy,
                    nodeBinding: {
                        field_0: "name",
                        field_1: "id"
                    },
                    nodes: Object.values(nodesMap).slice(0, 195)
                });

            } catch (e) {
                statusBox.innerText = "Lỗi nghiêm trọng: " + e.message;
            }
        }
        start();
    </script>
</body>
</html>
