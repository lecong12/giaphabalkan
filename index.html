<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - V85 (Sửa lỗi đứt nhánh)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #fff; }
        #tree { width: 100%; height: 100%; }
        .bft-license-message { display: none !important; }
    </style>
</head>
<body>
<div id="tree"></div>
<script>
    const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
    const urlData = `https://docs.google.com/spreadsheets/d/${ssId}/export?format=csv&gid=0`; 
    const urldData = `https://docs.google.com/spreadsheets/d/${ssId}/export?format=csv&gid=1705210560`;

    async function start() {
        const fetchCSV = (url) => new Promise(r => Papa.parse(url, {download:true, header:true, skipEmptyLines:true, complete:r}));
        
        try {
            const [res1, res2] = await Promise.all([fetchCSV(urlData), fetchCSV(urldData)]);
            
            // Hàm chuẩn hóa ID (Bỏ mọi ký tự lạ, chỉ giữ số hoặc text sạch)
            const cleanId = (val) => {
                if (!val) return null;
                return String(val).trim();
            };

            // Hàm xử lý tên cột không phân biệt hoa thường
            const getVal = (row, keys) => {
                for (let k in row) {
                    if (keys.includes(k.toLowerCase().trim())) return row[k];
                }
                return null;
            };

            let members = res1.data.map(row => ({
                id: cleanId(getVal(row, ['id'])),
                fid: cleanId(getVal(row, ['fid', 'id cha'])),
                mid: cleanId(getVal(row, ['mid', 'id mẹ'])),
                name: getVal(row, ['full_name', 'họ và tên']),
                gender: (getVal(row, ['gender', 'giới tính']) || "").toLowerCase().includes('f') ? "female" : "male"
            })).filter(n => n.id);

            let spouses = res2.data.map(row => ({
                id: cleanId(getVal(row, ['id'])),
                pid: cleanId(getVal(row, ['pid', 'id vợ/chồng', 'id_vợ/chồng'])),
                name: getVal(row, ['full_name', 'họ và tên']),
                gender: (getVal(row, ['gender', 'giới tính']) || "").toLowerCase().includes('f') ? "female" : "male"
            })).filter(n => n.id);

            // Xử lý pids hai chiều cho Balkan
            let partnerMap = {};
            spouses.forEach(s => {
                if (s.pid) {
                    if (!partnerMap[s.pid]) partnerMap[s.pid] = [];
                    partnerMap[s.pid].push(s.id);
                }
            });

            const allNodes = [
                ...members.map(m => ({
                    id: m.id,
                    fid: m.fid,
                    mid: m.mid,
                    pids: partnerMap[m.id] || [],
                    name: m.name,
                    gender: m.gender
                })),
                ...spouses.map(s => ({
                    id: s.id,
                    pids: [s.pid],
                    name: s.name,
                    gender: s.gender
                }))
            ];

            new FamilyTree(document.getElementById("tree"), {
                mouseWheel: { zoom: true },
                template: "hugo",
                layout: FamilyTree.mixed,
                nodeBinding: { field_0: "name" },
                nodes: allNodes
            });

        } catch (e) { console.error(e); }
    }
    start();
</script>
</body>
</html>
