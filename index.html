<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công</title>
    <script src="https://balkan.app/js/FamilyTree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f4f7f6; }
        #tree { width: 100%; height: 100%; }
        #loading { position: fixed; top: 20px; left: 20px; z-index: 100; background: white; padding: 10px; border: 1px solid #ccc; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="loading">Đang quét dữ liệu từ Google Sheets...</div>
    <div id="tree"></div>
    <script>
        const ssId = '1mX5C3YiDKb-R1Igweo10NsxCtmxIrG2hlCZM5OlPXEw';

        async function fetchCSV(sheetName) {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
                const response = await fetch(url);
                const text = await response.text();
                // Tự động dọn dẹp các dấu ngoặc kép thừa từ Google CSV
                const cleanText = text.replace(/"/g, ""); 
                return FamilyTree.csv.parse(cleanText);
            } catch (e) { return []; }
        }

        async function init() {
            const [dataMain, dataSpouses] = await Promise.all([
                fetchCSV('Data'),
                fetchCSV('dData')
            ]);

            const finalData = [];
            const partnerMap = {};

            // Xử lý dData
            dataSpouses.forEach(s => {
                const hId = (s.pid || s.PID || s[Object.keys(s)[2]] || "").toString().trim();
                const wId = (s.id || s.ID || s[Object.keys(s)[0]] || "").toString().trim();
                if (hId && wId) { partnerMap[hId] = wId; partnerMap[wId] = hId; }
            });

            // Xử lý Data chính
            dataMain.forEach(p => {
                const keys = Object.keys(p);
                // Tự động nhận diện cột dựa trên vị trí nếu tên bị lỗi
                const id = (p.id || p[keys[0]] || "").toString().trim();
                if (!id || id.toLowerCase() === "id") return;

                const name = p.full_name || p.fullname || p[keys[1]] || "Thành viên " + id;
                const fid = (p.fid || p[keys[2]] || "").toString().trim();
                const mid = partnerMap[fid] || "";
                const gender = (p.gender || p[keys[3]] || "").toString().toLowerCase().includes('fe') ? 'female' : 'male';

                finalData.push({
                    id: id,
                    name: name,
                    pids: (fid && mid) ? [fid, mid] : (fid ? [fid] : null),
                    gender: gender
                });
            });

            // Thêm vợ/chồng vào danh sách node
            dataSpouses.forEach(s => {
                const keys = Object.keys(s);
                const id = (s.id || s[keys[0]] || "").toString().trim();
                if (!id || id.toLowerCase() === "id") return;
                finalData.push({
                    id: id,
                    name: s.full_name || s.fullname || s[keys[1]] || "Thành viên " + id,
                    gender: 'female'
                });
            });

            if (finalData.length > 0) {
                document.getElementById('loading').style.display = 'none';
                var family = new FamilyTree(document.getElementById("tree"), {
                    template: "tommy",
                    nodeBinding: { field_0: "name" },
                    nodes: finalData
                });
            } else {
                document.getElementById('loading').innerText = "Vẫn không tìm thấy dữ liệu. Hãy kiểm tra lại quyền Chia sẻ file Sheets.";
            }
        }
        init();
    </script>
</body>
</html>
