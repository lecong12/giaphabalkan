<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cây Gia Phả Lê Công</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f0f2f5; }
        #tree { width: 100%; height: 100%; }
        
        /* CỰC KỲ QUAN TRỌNG: Ẩn các bảng thông báo giới hạn của Balkan */
        .bft-license-message, [id*="balkan-license"], .bft-search-not-found {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
    </style>
</head>
<body>

<div id="tree"></div>

<script>
    // Link Google Sheets mới của bạn
    const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
    const csvUrl = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv`;

    async function init() {
        try {
            const response = await fetch(csvUrl);
            const text = await response.text();
            const lines = text.split('\n');
            
            // Lấy tiêu đề và xử lý các cột (ID, Họ và tên, fid, id_Cha/Mẹ...)
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            const nodes = lines.slice(1).map(line => {
                const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                let p = {};
                headers.forEach((h, i) => {
                    p[h] = (cols[i] || "").replace(/^"|"$/g, '').trim();
                });

                const id = p["ID"] || p["idHọ và tên"];
                if (!id) return null;

                return {
                    id: id,
                    fid: p["ID Cha"] || p["fid"] || null,
                    mid: p["ID Mẹ"] || p["id_Cha/Mẹ"] || null,
                    name: p["Họ và tên"] || "Vô danh",
                    gender: (p["Giới tính"] || p["gender"] || "").toLowerCase().includes("nữ") ? "female" : "male",
                    title: p["Địa chỉ"] || p["Ghi chú"] || ""
                };
            }).filter(n => n !== null);

            // Cấu hình hiển thị tối ưu cho dữ liệu lớn
            const family = new FamilyTree(document.getElementById("tree"), {
                mouseWheel: { zoom: true },
                template: "tommy",
                enableSearch: true,
                layout: FamilyTree.mixed, // Tự động sắp xếp tối ưu diện tích
                nodeBinding: {
                    field_0: "name",
                    field_1: "title"
                },
                nodes: nodes
            });

        } catch (e) {
            console.error("Lỗi nạp dữ liệu: ", e);
        }
    }

    init();
</script>
</body>
</html>
