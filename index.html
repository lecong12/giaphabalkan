    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        let allNodes = []; 
        let family;

        async function fetchAllData() {
            const gids = ['0', '1705210560'];
            try {
                let rawData = [];
                for (let gid of gids) {
                    const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    const cols = json.table.cols.map(c => (c.label || "").toLowerCase().trim());
                    const rows = json.table.rows.map(row => {
                        let item = {};
                        row.c.forEach((cell, i) => { if (cols[i]) item[cols[i]] = cell ? String(cell.v) : null; });
                        return item;
                    });
                    rawData = rawData.concat(rows);
                }

                // Chuẩn hóa dữ liệu
                allNodes = rawData.filter(r => r.id).map(r => ({
                    id: r.id,
                    pids: (r.pid && r.pid !== "0") ? [r.pid] : [],
                    mid: (r.mid && r.mid !== "0") ? r.mid : null,
                    fid: (r.fid && r.fid !== "0") ? r.fid : null,
                    name: r.full_name || r.name || "Thành viên",
                    gender: (r.gender && r.gender.toLowerCase().includes('f')) ? "female" : "male"
                }));

                // Xử lý ngược pids: Nếu B có pids [A] thì A cũng phải có pids [B]
                allNodes.forEach(node => {
                    if (node.pids.length > 0) {
                        node.pids.forEach(partnerId => {
                            let partner = allNodes.find(n => n.id == partnerId);
                            if (partner && !partner.pids.includes(node.id)) {
                                partner.pids.push(node.id);
                            }
                        });
                    }
                });

                renderInitialTree();
            } catch (e) {
                console.error(e);
                document.getElementById("loading").innerText = "Lỗi dữ liệu: " + e.message;
            }
        }

        function renderInitialTree() {
            // Lấy 15 người đầu tiên từ Sheet Data để làm gốc (tránh bị trống)
            const initialIds = allNodes.slice(0, 15).map(n => n.id);
            const initialData = getFamilyGroup(initialIds);

            document.getElementById("loading").style.display = "none";

            family = new FamilyTree(document.getElementById("tree"), {
                template: "hugo",
                nodeBinding: { field_0: "name" },
                nodes: initialData
            });

            // Sự kiện Click: Nạp thêm con cái và vợ chồng của con cái
            family.on('click', function (sender, args) {
                const id = args.node.id;
                const toAdd = [];
                
                // 1. Tìm con cái
                const children = allNodes.filter(n => n.fid == id || n.mid == id);
                children.forEach(child => {
                    if (!family.get(child.id)) {
                        toAdd.push(child);
                        // 2. Tìm phối ngẫu của con cái đó
                        const partners = allNodes.filter(n => n.pids.includes(child.id));
                        partners.forEach(p => { if (!family.get(p.id)) toAdd.push(p); });
                    }
                });

                if (toAdd.length > 0) {
                    family.add(toAdd);
                }
            });
        }

        function getFamilyGroup(ids) {
            let result = [];
            let setIds = new Set();

            ids.forEach(id => {
                const member = allNodes.find(n => n.id == id);
                if (member && !setIds.has(member.id)) {
                    result.push(member);
                    setIds.add(member.id);
                    
                    // Lấy luôn phối ngẫu của người này
                    allNodes.filter(n => n.pids.includes(member.id)).forEach(p => {
                        if (!setIds.has(p.id)) { result.push(p); setIds.add(p.id); }
                    });
                }
            });
            return result;
        }

        fetchAllData();
    </script>
