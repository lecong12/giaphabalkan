<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công</title>
    <script src="https://balkan.app/js/FamilyTree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f4f7f6; }
        #tree { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="tree"></div>
    <script>
        const ssId = '1mX5C3YiDKb-R1Igweo10NsxCtmxIrG2hlCZM5OlPXEw';

        function clean(val) { return val ? String(val).replace(/"/g, "").trim() : ""; }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => clean(h).toLowerCase());
            return lines.slice(1).map(line => {
                const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                let obj = {};
                headers.forEach((header, i) => { obj[header] = clean(values[i]); });
                return obj;
            });
        }

        async function init() {
            try {
                const [resMain, resSpouses] = await Promise.all([
                    fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&sheet=Data`),
                    fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&sheet=dData`)
                ]);

                const dataMain = parseCSV(await resMain.text());
                const dataSpouses = parseCSV(await resSpouses.text());

                let nodes = [];
                let registeredIds = new Set();

                // 1. Nạp tất cả ID hiện có
                dataMain.forEach(p => registeredIds.add(p.id));
                dataSpouses.forEach(s => registeredIds.add(s.id));

                // 2. Xử lý thành viên chính
                dataMain.forEach(p => {
                    if (!p.id) return;
                    let node = {
                        id: p.id,
                        name: p.full_name,
                        gender: (p.gender.toLowerCase().includes('fe') || p.gender.toLowerCase().includes('nữ')) ? 'female' : 'male'
                    };
                    // Chỉ nối nếu cha/mẹ có tồn tại trong danh sách ID
                    let pids = [];
                    if (p.fid && registeredIds.has(p.fid)) pids.push(p.fid);
                    if (p.mid && registeredIds.has(p.mid)) pids.push(p.mid);
                    if (pids.length > 0) node.pids = pids;
                    
                    nodes.push(node);
                });

                // 3. Xử lý vợ chồng
                dataSpouses.forEach(s => {
                    if (!s.id) return;
                    nodes.push({
                        id: s.id,
                        name: s.full_name,
                        partnerId: registeredIds.has(s.pid) ? s.pid : null,
                        gender: 'female'
                    });
                });

                const family = new FamilyTree(document.getElementById("tree"), {
                    template: "tommy",
                    nodeBinding: { field_0: "name" },
                    enableSearch: true,
                    // Ép sơ đồ vẽ theo kiểu cây dọc (từ tổ tiên xuống)
                    layout: FamilyTree.mixed,
                    nodes: nodes
                });

                // Nếu có cụ Mao (ID 1), tự động tập trung vào cụ để hiện cây
                if (registeredIds.has("1")) family.fit();

            } catch (e) { console.error(e); }
        }
        init();
    </script>
</body>
</html>
