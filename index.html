<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Hệ Thống Dò Tìm</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #ffffff; }
        #tree { width: 100%; height: 100%; }
        #debug { position: fixed; bottom: 10px; left: 10px; z-index: 999; background: #222; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 5px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="debug">Đang khởi động...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        const debug = document.getElementById("debug");

        function log(msg) { debug.innerHTML += "<br>> " + msg; debug.scrollTop = debug.scrollHeight; }

        async function start() {
            try {
                const fetchSheet = async (gid) => {
                    const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
                    return json.table.rows;
                };

                log("Đang tải dữ liệu từ Google...");
                const [dataRows, dDataRows] = await Promise.all([fetchSheet('0'), fetchSheet('1705210560')]);
                
                let nodes = [];
                let partnerMap = {};

                // 1. Dò tìm Sheet Phối ngẫu (dData)
                dDataRows.forEach(row => {
                    if (!row.c) return;
                    let vals = row.c.map(cell => cell ? String(cell.v) : "");
                    // Giả định: ô đầu là ID vợ, ô thứ hai là PID chồng, ô thứ ba là Tên
                    let id = vals;
                    let pid = vals;
                    let name = vals || vals || "Vợ/Chồng";

                    if (id && pid && !isNaN(id) && id !== "0") {
                        if (!partnerMap[pid]) partnerMap[pid] = [];
                        partnerMap[pid].push(id);
                        nodes.push({ id: id, pids: [pid], name: name, gender: "female" });
                    }
                });

                // 2. Dò tìm Sheet Huyết thống (Data)
                dataRows.forEach(row => {
                    if (!row.c) return;
                    let vals = row.c.map(cell => cell ? String(cell.v) : "");
                    let id = vals;
                    
                    if (id && !isNaN(id) && id !== "0") {
                        let name = vals || vals || ("Thành viên " + id);
                        let genderStr = (vals || "").toLowerCase();
                        let gender = (genderStr.includes('f') || genderStr.includes('nữ')) ? "female" : "male";

                        nodes.push({
                            id: id,
                            fid: (vals && vals != "0") ? vals : null,
                            mid: (vals && vals != "0") ? vals : null,
                            pids: partnerMap[id] || [],
                            name: name,
                            gender: gender
                        });
                    }
                });

                log("Tổng số Node tìm được: " + nodes.length);

                if (nodes.length === 0) {
                    log("KHÔNG CÓ DỮ LIỆU! Kiểm tra lại định dạng số ID ở cột A.");
                    return;
                }

                // Giới hạn để không lỗi bản quyền
                const finalNodes = nodes.slice(0, 195);
                setTimeout(() => { debug.style.display = "none"; }, 3000);

                new FamilyTree(document.getElementById("tree"), {
                    mouseScrol: FamilyTree.action.zoom,
                    template: "hugo",
                    nodeBinding: { field_0: "name", field_1: "id" },
                    nodes: finalNodes
                });

            } catch (e) {
                log("LỖI: " + e.message);
                console.error(e);
            }
        }
        start();
    </script>
</body>
</html>
