<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công</title>
    <script src="https://cdn.balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #ffffff; }
        #tree { width: 100%; height: 100%; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: sans-serif; z-index: 1000; background: #fff; padding: 20px; border: 2px solid #333; }
    </style>
</head>
<body>
    <div id="loading">Đang nạp dữ liệu gia tộc Lê Công...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1mX5C3YiDKb-R1Igweo10NsxCtmxIrG2hlCZM5OlPXEw';

        async function init() {
            // Chờ thư viện nạp xong
            if (typeof FamilyTree === 'undefined') {
                setTimeout(init, 300);
                return;
            }

            try {
                // Lấy dữ liệu trực tiếp từ sheet Data
                const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&sheet=Data`;
                const response = await fetch(url);
                const text = await response.text();
                
                // Tự xử lý CSV thay vì dùng thư viện để tránh lỗi undefined
                const rows = text.split('\n').map(line => line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
                const headers = rows[0].map(h => h.replace(/"/g, "").trim().toLowerCase());
                
                const finalData = [];
                for (let i = 1; i < rows.length; i++) {
                    let obj = {};
                    rows[i].forEach((val, j) => {
                        if (headers[j]) obj[headers[j]] = val.replace(/"/g, "").trim();
                    });
                    
                    if (obj.id) {
                        finalData.push({
                            id: obj.id,
                            pids: (obj.fid && obj.mid) ? [obj.fid, obj.mid] : (obj.fid ? [obj.fid] : null),
                            name: obj.full_name || "Thành viên " + obj.id,
                            gender: (obj.gender && obj.gender.toLowerCase().includes('fe')) ? 'female' : 'male'
                        });
                    }
                }

                document.getElementById('loading').style.display = 'none';

                const family = new FamilyTree(document.getElementById("tree"), {
                    template: "tommy",
                    nodeBinding: { field_0: "name" },
                    nodes: finalData
                });

            } catch (err) {
                document.getElementById('loading').innerHTML = "Lỗi nạp dữ liệu: " + err.message;
            }
        }
        window.onload = init;
    </script>
</body>
</html>
