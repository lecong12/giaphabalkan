<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Bản V79</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #fff; }
        #tree { width: 100%; height: 100%; }
        .bft-license-message { display: none !important; }
        #status { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: #fff; padding: 8px 15px; border-radius: 4px; z-index: 1000; font-family: sans-serif; }
    </style>
</head>
<body>

<div id="status">Đang kết nối Data & dData...</div>
<div id="tree"></div>

<script>
    const sheetID = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
    const urlData = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:csv&sheet=Data`;
    const urldData = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:csv&sheet=dData`;

    function fetchCSV(url) {
        return new Promise((resolve, reject) => {
            Papa.parse(url, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: results => resolve(results.data),
                error: err => reject(err)
            });
        });
    }

    async function init() {
        try {
            const [dataMembers, dataSpouses] = await Promise.all([
                fetchCSV(urlData),
                fetchCSV(urldData)
            ]);

            // 1. Xử lý thành viên gốc (Sheet Data)
            const nodesMembers = dataMembers.map(row => {
                const id = row["id"] || row["ID"];
                if (!id) return null;
                return {
                    id: id,
                    fid: row["fid"] || null,
                    mid: row["mid"] || null,
                    name: row["full_name"] || "Không tên",
                    gender: (row["gender"] || "").toLowerCase().includes("f") ? "female" : "male",
                    address: row["Địa chỉ"] || "" 
                };
            });

            // 2. Xử lý Vợ/Chồng (Sheet dData) và tạo liên kết hôn nhân
            const nodesSpouses = dataSpouses.map(row => {
                const id = row["id"] || row["ID"];
                const partnerId = row["pid"]; // Cột kết nối với chồng/vợ ở bảng Data
                if (!id) return null;

                return {
                    id: id,
                    pids: partnerId ? [partnerId] : [], // pids là mảng các ID vợ/chồng trong Balkan
                    name: row["full_name"] || "Không tên",
                    gender: (row["gender"] || "").toLowerCase().includes("f") ? "female" : "male",
                    address: row["Địa chỉ"] || ""
                };
            });

            const allNodes = [...nodesMembers, ...nodesSpouses].filter(n => n !== null);

            document.getElementById('status').innerText = `Đã nạp ${allNodes.length} người.`;
            setTimeout(() => document.getElementById('status').style.display = 'none', 3000);

            // 3. Vẽ sơ đồ
            new FamilyTree(document.getElementById("tree"), {
                mouseWheel: { zoom: true },
                template: "tommy",
                enableSearch: true,
                nodeBinding: {
                    field_0: "name",
                    field_1: "address"
                },
                nodes: allNodes
            });

        } catch (error) {
            document.getElementById('status').innerText = "Lỗi nạp dữ liệu!";
            console.error(error);
        }
    }

    init();
</script>
</body>
</html>
