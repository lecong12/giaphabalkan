<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - V99</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #fff; }
        #tree { width: 100%; height: 100%; }
        #loader { position: fixed; top: 10px; left: 10px; z-index: 100; font-family: sans-serif; background: yellow; padding: 5px; }
        .bft-license-message { display: none !important; }
    </style>
</head>
<body>
    <div id="loader">Hệ thống đang nạp dữ liệu...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';

        async function fetchSheet(gid) {
            const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
            const res = await fetch(url);
            const text = await res.text();
            const json = JSON.parse(text.substring(47, text.length - 2));
            const cols = json.table.cols.map(c => (c.label || "").toLowerCase().trim());
            return json.table.rows.map(row => {
                let obj = {};
                row.c.forEach((cell, i) => { if (cols[i]) obj[cols[i]] = cell ? (cell.v !== null ? String(cell.v).trim() : null) : null; });
                return obj;
            });
        }

        async function start() {
            try {
                // Tải dữ liệu từ 2 bảng (Gid 0 và 1705210560)
                const [data, dData] = await Promise.all([fetchSheet(0), fetchSheet(1705210560)]);
                
                // 1. Tạo bản đồ vợ chồng từ dData (Bà 5001 -> Ông 1)
                let spouseLinks = {};
                dData.forEach(row => {
                    if (row.id && row.pid) {
                        if (!spouseLinks[row.pid]) spouseLinks[row.pid] = [];
                        spouseLinks[row.pid].push(row.id);
                    }
                });

                // 2. Gộp tất cả thành Node
                let nodes = [];

                // Thêm người trong tộc (Sheet Data)
                data.forEach(m => {
                    if (m.id) {
                        nodes.push({
                            id: m.id,
                            fid: m.fid || null,
                            mid: m.mid || null, // Nối tới ID mẹ bên dData
                            pids: spouseLinks[m.id] || [], // Tự gắn vợ vào
                            name: m.full_name || "Vô danh",
                            gender: (m.gender || "").toLowerCase().includes('f') ? "female" : "male"
                        });
                    }
                });

                // Thêm dâu/rể (Sheet dData)
                dData.forEach(s => {
                    if (s.id) {
                        nodes.push({
                            id: s.id,
                            pids: s.pid ? [s.pid] : [], // Tự gắn chồng vào
                            name: s.full_name || "Vô danh",
                            gender: "female"
                        });
                    }
                });

                document.getElementById('loader').style.display = 'none';

                // 3. Vẽ cây (Dùng template cơ bản nhất để không lỗi)
                new FamilyTree(document.getElementById("tree"), {
                    template: "hugo",
                    layout: FamilyTree.mixed,
                    nodeBinding: { field_0: "name" },
                    nodes: nodes
                });

            } catch (e) {
                document.getElementById('loader').innerHTML = "LỖI: " + e.message;
                document.getElementById('loader').style.background = "red";
            }
        }
        start();
    </script>
</body>
</html>
