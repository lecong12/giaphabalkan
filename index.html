<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Kiểm Tra Kết Nối</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #f4f4f4; }
        #tree { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        #info { position: fixed; top: 10px; left: 10px; z-index: 9999; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ccc; font-family: sans-serif; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .success { color: green; font-weight: bold; }
        .error { color: red; }
    </style>
</head>
<body>
    <div id="info">
        <b>Trạng thái hệ thống:</b>
        <div id="step1">1. Đang tải thư viện... Đang chờ</div>
        <div id="step2">2. Đang đọc Google Sheets... Đang chờ</div>
        <div id="step3">3. Đang bóc tách dữ liệu... Đang chờ</div>
    </div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        
        // Kiểm tra thư viện Balkan
        if (typeof FamilyTree !== 'undefined') {
            document.getElementById('step1').innerHTML = '1. Thư viện Balkan: <span class="success">OK</span>';
        } else {
            document.getElementById('step1').innerHTML = '1. Thư viện Balkan: <span class="error">Lỗi tải script!</span>';
        }

        async function start() {
            try {
                // Hàm lấy dữ liệu sạch
                const fetchRaw = async (gid) => {
                    const res = await fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`);
                    const text = await res.text();
                    return JSON.parse(text.substring(47, text.length - 2));
                };

                const [data, dData] = await Promise.all([fetchRaw('0'), fetchRaw('1705210560')]);
                document.getElementById('step2').innerHTML = '2. Google Sheets: <span class="success">Đã nhận dữ liệu</span>';

                let nodes = [];
                let partnerMap = {};

                // Bóc tách Phối ngẫu
                dData.table.rows.forEach(row => {
                    if (!row.c || !row.c) return;
                    let id = String(row.c.f || row.c.v).split(',').replace(/\D/g, '');
                    let pid = String(row.c?.f || row.c?.v || "").split(',').replace(/\D/g, '');
                    let name = String(row.c?.f || row.c?.v || "Vợ/Chồng").split(',') || "Vợ/Chồng";
                    
                    if (id && pid) {
                        nodes.push({ id, pids: [pid], name, gender: "female" });
                        if (!partnerMap[pid]) partnerMap[pid] = [];
                        partnerMap[pid].push(id);
                    }
                });

                // Bóc tách Huyết thống
                data.table.rows.forEach((row, i) => {
                    if (i === 0 || !row.c || !row.c) return;
                    let id = String(row.c.f || row.c.v).split(',').replace(/\D/g, '');
                    if (id) {
                        let name = String(row.c?.f || row.c?.v || row.c.f || "Thành viên").split(',') || "Thành viên";
                        let fid = String(row.c?.f || row.c?.v || "").split(',').replace(/\D/g, '');
                        let mid = String(row.c?.f || row.c?.v || "").split(',').replace(/\D/g, '');
                        
                        nodes.push({
                            id, fid, mid,
                            pids: partnerMap[id] || [],
                            name: name.trim(),
                            gender: String(row.c?.v || "").toLowerCase().includes('nữ') ? "female" : "male"
                        });
                    }
                });

                document.getElementById('step3').innerHTML = `3. Dữ liệu: <span class="success">Đã tìm thấy ${nodes.length} người</span>`;
                setTimeout(() => document.getElementById('info').style.display = 'none', 3000);

                // Vẽ cây
                [attachment_0](attachment)
                new FamilyTree(document.getElementById("tree"), {
                    template: "hugo",
                    layout: FamilyTree.layout.hierarchy,
                    nodeBinding: { field_0: "name", field_1: "id" },
                    nodes: nodes.slice(0, 195)
                });

            } catch (e) {
                document.getElementById('step2').innerHTML = `2. Google Sheets: <span class="error">Lỗi kết nối hoặc file chưa chia sẻ!</span>`;
                console.error(e);
            }
        }

        start();
    </script>
</body>
</html>
