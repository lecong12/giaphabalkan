    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        
        async function start() {
            try {
                const fetchSheet = async (gid) => {
                    const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const startIdx = text.indexOf('{');
                    const endIdx = text.lastIndexOf('}');
                    const json = JSON.parse(text.substring(startIdx, endIdx + 1));
                    
                    // Lấy dữ liệu theo vị trí cột (index) để không bị sai tên cột
                    return json.table.rows.map(row => {
                        return row.c.map(cell => (cell && cell.v !== null) ? String(cell.v).trim() : "");
                    }).filter(r => r && r !== "id" && r !== "ID"); // Bỏ dòng tiêu đề và dòng trống
                };

                // Tải dữ liệu từ 2 Sheet
                const [dataRows, dDataRows] = await Promise.all([fetchSheet('0'), fetchSheet('1705210560')]);
                
                let nodesMap = {};
                let partnerMap = {}; 

                // 1. Xử lý Phối ngẫu (Sheet dData)
                // Giả định: Cột 0 là ID, Cột 1 là PID (ID chồng), Cột 2 hoặc 3 là Tên
                dDataRows.forEach(r => {
                    let id = r;
                    let pid = r;
                    let name = r || r || "Phối ngẫu";
                    if (id && pid) {
                        if (!partnerMap[pid]) partnerMap[pid] = [];
                        partnerMap[pid].push(id);

                        nodesMap[id] = {
                            id: id,
                            pids: [pid],
                            name: name,
                            gender: "female"
                        };
                    }
                });

                // 2. Xử lý Huyết thống (Sheet Data)
                // Giả định: Cột 0: ID, Cột 1: FID, Cột 2: MID, Cột 3: Tên
                dataRows.forEach(r => {
                    let id = r;
                    if (id) {
                        nodesMap[id] = {
                            id: id,
                            fid: (r && r !== "0") ? r : null,
                            mid: (r && r !== "0") ? r : null,
                            pids: partnerMap[id] || [], 
                            name: r || r || "Thành viên",
                            gender: (r && r.toLowerCase().includes('f')) ? "female" : "male"
                        };
                    }
                });

                let allNodes = Object.values(nodesMap);
                // Sắp xếp để đời cụ Tổ hiện lên trước
                allNodes.sort((a, b) => parseInt(a.id) - parseInt(b.id));
                
                // LÁCH LUẬT 200 NODES: Chỉ lấy 180 người đầu tiên
                const finalNodes = allNodes.slice(0, 180);

                if(document.getElementById("status")) document.getElementById("status").style.display = "none";

                new FamilyTree(document.getElementById("tree"), {
                    mouseScrol: FamilyTree.action.zoom,
                    template: "hugo",
                    nodeBinding: { 
                        field_0: "name", 
                        field_1: "id" 
                    },
                    nodes: finalNodes
                });

            } catch (e) {
                console.error("Lỗi:", e);
                if(document.getElementById("status")) document.getElementById("status").innerText = "Lỗi: " + e.message;
            }
        }
        start();
    </script>
