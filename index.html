    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        
        async function start() {
            try {
                const fetchSheet = async (gid) => {
                    const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    const cols = json.table.cols.map(c => (c.label || "").toLowerCase().trim());
                    return json.table.rows.map(row => {
                        let item = {};
                        row.c.forEach((cell, i) => { if (cols[i]) item[cols[i]] = (cell && cell.v !== null) ? String(cell.v).trim() : null; });
                        return item;
                    }).filter(r => r.id);
                };

                // Tải dữ liệu
                const [data, dData] = await Promise.all([fetchSheet('0'), fetchSheet('1705210560')]);
                
                let nodesMap = {};
                let partnerMap = {}; // Lưu quan hệ: ID_Chồng -> [ID_Vợ1, ID_Vợ2...]

                // BƯỚC 1: Quét sheet dData để lấy danh sách Vợ/Chồng và tạo liên kết
                dData.forEach(p => {
                    if (p.id && p.pid) {
                        // Lưu vào partnerMap để tí nữa gắn vào Chồng
                        if (!partnerMap[p.pid]) partnerMap[p.pid] = [];
                        partnerMap[p.pid].push(p.id);

                        // Tạo node cho Vợ
                        nodesMap[p.id] = {
                            id: p.id,
                            pids: [p.pid], // Nối ngược về chồng
                            name: p.full_name || "Vợ/Chồng",
                            gender: "female"
                        };
                    }
                });

                // BƯỚC 2: Quét sheet Data để lấy Huyết thống và gắn Vợ vào
                data.forEach(m => {
                    if (m.id) {
                        nodesMap[m.id] = {
                            id: m.id,
                            fid: (m.fid && m.fid !== "0") ? m.fid : null,
                            mid: (m.mid && m.mid !== "0") ? m.mid : null,
                            pids: partnerMap[m.id] || [], // Lấy danh sách ID vợ từ dData đã quét ở Bước 1
                            name: m.full_name || "Thành viên",
                            gender: (m.gender && m.gender.toLowerCase().includes('f')) ? "female" : "male"
                        };
                    }
                });

                // BƯỚC 3: Chuyển đổi Map thành mảng và lách luật 200 node
                // Ưu tiên nạp các đời đầu (ID nhỏ) để đảm bảo tính logic cha con
                let allNodes = Object.values(nodesMap);
                
                // Sắp xếp theo ID để đảm bảo cha luôn được nạp trước hoặc cùng lúc với con
                allNodes.sort((a, b) => parseInt(a.id) - parseInt(b.id));

                const finalNodes = allNodes.slice(0, 190);

                document.getElementById("loading").style.display = "none";

                const family = new FamilyTree(document.getElementById("tree"), {
                    mouseScrol: FamilyTree.action.zoom,
                    template: "hugo",
                    nodeBinding: {
                        field_0: "name",
                        field_1: "id"
                    },
                    nodes: finalNodes
                });

            } catch (e) {
                console.error(e);
                document.getElementById("loading").innerText = "Lỗi logic: " + e.message;
            }
        }
        start();
    </script>
