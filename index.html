<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Dữ Liệu Tự Động</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #ffffff; }
        #tree { width: 100%; height: 100%; position: absolute; }
        #monitor { position: fixed; top: 10px; left: 10px; z-index: 9999; background: #000; color: #0f0; padding: 10px; font-family: monospace; font-size: 12px; border-radius: 5px; opacity: 0.9; }
    </style>
</head>
<body>
    <div id="monitor">Đang quét dữ liệu tự động...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        const mon = document.getElementById("monitor");

        // Hàm bóc tách ID từ dữ liệu tự động (Ví dụ: "170, Lê..." -> "170")
        function cleanId(val) {
            if (val === null || val === undefined) return null;
            let s = String(val).split(','); // Lấy phần trước dấu phẩy
            let id = s.replace(/\D/g, '');    // Chỉ giữ lại số
            return id || null;
        }

        // Hàm bóc tách Tên
        function cleanName(val) {
            if (!val) return "Thành viên";
            let s = String(val);
            if (s.includes(',')) return s.split(',').slice(1).join(',').trim();
            return s.trim();
        }

        async function start() {
            try {
                const fetchSheet = async (gid) => {
                    const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    return json.table.rows;
                };

                const [dataRows, dDataRows] = await Promise.all([fetchSheet('0'), fetchSheet('1705210560')]);
                
                let nodesMap = {};
                let partnerMap = {}; 

                // 1. Quét Sheet phối ngẫu (dData)
                dDataRows.forEach(row => {
                    if (!row.c) return;
                    // Dùng .f (Formatted Value) để đọc kết quả của công thức tự động
                    let rawId = row.c?.f || row.c?.v;
                    let rawPid = row.c?.f || row.c?.v;
                    let id = cleanId(rawId);
                    let pid = cleanId(rawPid);
                    
                    if (id && pid) {
                        nodesMap[id] = { id, pids: [pid], name: cleanName(rawId), gender: "female" };
                        if (!partnerMap[pid]) partnerMap[pid] = [];
                        partnerMap[pid].push(id);
                    }
                });

                // 2. Quét Sheet huyết thống (Data)
                dataRows.forEach((row, i) => {
                    if (i === 0 || !row.c) return;
                    let rawId = row.c?.f || row.c?.v;
                    let id = cleanId(rawId);
                    
                    if (id) {
                        let fid = cleanId(row.c?.f || row.c?.v);
                        let mid = cleanId(row.c?.f || row.c?.v);
                        let name = cleanName(row.c?.f || row.c?.v || rawId);
                        let gender = String(row.c?.f || row.c?.v || "").toLowerCase().includes('nữ') ? "female" : "male";

                        nodesMap[id] = {
                            id, fid, mid,
                            pids: partnerMap[id] || [],
                            name: name,
                            gender: gender
                        };
                    }
                });

                const nodes = Object.values(nodesMap);
                mon.innerHTML = `✅ Đã nạp ${nodes.length} thành viên.`;

                if (nodes.length > 0) {
                    setTimeout(() => mon.style.display = "none", 3000);
                    [attachment_0](attachment)
                    new FamilyTree(document.getElementById("tree"), {
                        template: "hugo",
                        layout: FamilyTree.layout.hierarchy,
                        nodeBinding: { field_0: "name", field_1: "id" },
                        nodes: nodes.slice(0, 195)
                    });
                } else {
                    mon.innerHTML = "❌ Không tìm thấy dữ liệu. Hãy kiểm tra cột ID.";
                }

            } catch (e) {
                mon.innerHTML = "❌ Lỗi: " + e.message;
            }
        }
        start();
    </script>
</body>
</html>
