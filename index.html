<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Bản Sửa Lỗi</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #fff; }
        #tree { width: 100%; height: 100%; }
        #status { position: fixed; top: 10px; left: 10px; z-index: 1000; background: #000; color: #fff; padding: 10px; border-radius: 5px; font-family: sans-serif; font-size: 13px; }
    </style>
</head>
<body>
    <div id="status">Đang nạp dữ liệu...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';

        // Hàm bóc tách ID - Ép kiểu String cưỡng bách để không bị lỗi 'undefined'
        function toId(val) {
            if (val === null || val === undefined || val === "") return null;
            var s = String(val).split(','); 
            var id = s.replace(/[^\d]/g, '');
            return id || null;
        }

        async function start() {
            try {
                const fetchSheet = async (gid) => {
                    const res = await fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`);
                    const text = await res.text();
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    return json.table.rows;
                };

                // Lấy dữ liệu từ 2 Sheet
                const [rows1, rows2] = await Promise.all([fetchSheet('0'), fetchSheet('1705210560')]);
                
                var nodes = [];
                var partnerMap = {}; 

                // 1. Quét Sheet phối ngẫu (Vợ/Chồng)
                rows2.forEach(function(row) {
                    if (!row.c || !row.c) return;
                    var id = toId(row.c.v);
                    var pid = toId(row.c ? row.c.v : null);
                    var rawName = row.c ? row.c.v : (row.c.v || "");
                    var name = String(rawName).includes(',') ? String(rawName).split(',') : String(rawName);
                    
                    if (id && pid) {
                        nodes.push({ id: id, pids: [pid], name: name.trim(), gender: "female" });
                        if (!partnerMap[pid]) partnerMap[pid] = [];
                        partnerMap[pid].push(id);
                    }
                });

                // 2. Quét Sheet huyết thống
                rows1.forEach(function(row, i) {
                    if (i === 0 || !row.c || !row.c) return;
                    var id = toId(row.c.v);
                    if (id) {
                        var rawName = row.c ? row.c.v : (row.c.v || "");
                        var name = String(rawName).includes(',') ? String(rawName).split(',') : String(rawName);
                        var gender = String(row.c ? row.c.v : "").toLowerCase().includes('nữ') ? "female" : "male";

                        nodes.push({
                            id: id,
                            fid: toId(row.c ? row.c.v : null),
                            mid: toId(row.c ? row.c.v : null),
                            pids: partnerMap[id] || [],
                            name: name.trim(),
                            gender: gender
                        });
                    }
                });

                document.getElementById("status").style.display = "none";

                // Vẽ cây - Layout Hierarchy giúp hết lộn xộn
                [attachment_0](attachment)
                new FamilyTree(document.getElementById("tree"), {
                    template: "hugo",
                    layout: FamilyTree.layout.hierarchy,
                    nodeBinding: {
                        field_0: "name",
                        field_1: "id"
                    },
                    nodes: nodes.slice(0, 198)
                });

            } catch (e) {
                document.getElementById("status").innerHTML = "Lỗi: " + e.message;
            }
        }
        start();
    </script>
</body>
</html>
