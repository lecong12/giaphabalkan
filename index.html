<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - V96</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #fff; }
        #tree { width: 100%; height: 100%; }
        .bft-license-message { display: none !important; }
    </style>
</head>
<body>
<div id="tree"></div>
<script>
    const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
    // Link CSV trực tiếp giúp tránh lỗi bảo mật và trắng màn hình
    const url1 = `https://docs.google.com/spreadsheets/d/${ssId}/export?format=csv&gid=0`; 
    const url2 = `https://docs.google.com/spreadsheets/d/${ssId}/export?format=csv&gid=1705210560`;

    async function fetchCSV(url) {
        const response = await fetch(url);
        const text = await response.text();
        const rows = text.split('\n').map(row => row.split(','));
        const headers = rows[0].map(h => h.trim().toLowerCase());
        
        return rows.slice(1).map(row => {
            let obj = {};
            headers.forEach((h, i) => { if (row[i]) obj[h] = row[i].replace(/"/g, '').trim(); });
            return obj;
        });
    }

    async function start() {
        try {
            const [data, dData] = await Promise.all([fetchCSV(url1), fetchCSV(url2)]);

            // 1. Tạo liên kết vợ chồng 2 chiều
            let pidsMap = {};
            dData.forEach(row => {
                if (row.pid && row.id) {
                    if (!pidsMap[row.pid]) pidsMap[row.pid] = [];
                    pidsMap[row.pid].push(row.id);
                }
            });

            // 2. Chuẩn hóa dữ liệu cho Balkan
            const nodes = [];

            // Thêm người từ bảng Data
            data.forEach(m => {
                if (m.id) {
                    nodes.push({
                        id: m.id,
                        fid: m.fid || null,
                        mid: m.mid || null,
                        pids: pidsMap[m.id] || [],
                        name: m.full_name || "Thành viên",
                        gender: (m.gender || "").toLowerCase().includes('f') ? "female" : "male"
                    });
                }
            });

            // Thêm dâu/rể từ bảng dData
            dData.forEach(s => {
                if (s.id) {
                    nodes.push({
                        id: s.id,
                        pids: s.pid ? [s.pid] : [],
                        name: s.full_name || "Vợ/Chồng",
                        gender: (s.gender || "").toLowerCase().includes('f') ? "female" : "male"
                    });
                }
            });

            // 3. Vẽ cây
            new FamilyTree(document.getElementById("tree"), {
                template: "hugo",
                nodeBinding: { field_0: "name" },
                nodes: nodes
            });

        } catch (e) {
            console.error("Lỗi:", e);
            document.body.innerHTML = "<h3 style='padding:20px'>Lỗi nạp dữ liệu. Hãy kiểm tra quyền chia sẻ bảng tính!</h3>";
        }
    }
    start();
</script>
</body>
</html>
