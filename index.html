<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Ph·∫£ L√™ C√¥ng - B·∫£n T·ª± ƒê·ªông D√≤ C·ªôt</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #ffffff; }
        #tree { width: 100%; height: 100%; position: absolute; }
        #debug { position: fixed; top: 10px; left: 10px; z-index: 9999; background: #000; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 11px; line-height: 1.5; }
    </style>
</head>
<body>
    <div id="debug">ƒêang kh·ªüi ƒë·ªông radar d√≤ d·ªØ li·ªáu...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        const log = document.getElementById("debug");

        function getCellText(cell) {
            if (!cell) return "";
            return (cell.f || cell.v || "").toString().trim();
        }

        // H√†m th√¥ng minh: T√¨m ID v√† T√™n trong 1 h√†ng b·∫•t k·ªÉ ·ªü c·ªôt n√†o
        function parseRow(rowCells) {
            let data = { id: null, name: "Th√†nh vi√™n", fid: null, mid: null, gender: "male" };
            let rawValues = rowCells.map(c => getCellText(c));

            // Gi·∫£ ƒë·ªãnh th·ª© t·ª± d·ª±a tr√™n c·∫•u tr√∫c th√¥ng th∆∞·ªùng
            // ID: th∆∞·ªùng l√† √¥ c√≥ ch·ª©a s·ªë ƒë·∫ßu ti√™n
            rawValues.forEach((val, index) => {
                if (!val) return;
                let idMatch = val.match(/^\d+/);
                
                if (idMatch) {
                    let num = idMatch;
                    if (index === 0) data.id = num;
                    else if (index === 1) data.fid = num;
                    else if (index === 2) data.mid = num;
                    
                    // N·∫øu √¥ c√≥ ch·ª©a d·∫•u ph·∫©y, b√≥c t√°ch t√™n
                    if (val.includes(',')) {
                        let namePart = val.split(',').slice(1).join(',').trim();
                        if (index === 0) data.name = namePart;
                    }
                }

                // D√≤ gi·ªõi t√≠nh
                let lowerVal = val.toLowerCase();
                if (lowerVal.includes('n·ªØ') || lowerVal === 'f') data.gender = "female";
                
                // N·∫øu c·ªôt 3 (v·ªã tr√≠ 3) c√≥ ch·ªØ m√† ch∆∞a c√≥ t√™n, l·∫•y l√†m t√™n
                if (index === 3 && data.name === "Th√†nh vi√™n") data.name = val;
            });

            return data;
        }

        async function start() {
            try {
                const fetchSheet = async (gid) => {
                    const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    return json.table.rows;
                };

                log.innerHTML = "üì° ƒêang qu√©t s√≥ng Google Sheets...";
                const [dataRows, dDataRows] = await Promise.all([fetchSheet('0'), fetchSheet('1705210560')]);
                
                let nodesMap = {};
                let partnerMap = {}; 

                // 1. Qu√©t Sheet ph·ªëi ng·∫´u
                dDataRows.forEach((row, i) => {
                    if (i === 0 || !row.c) return;
                    let p = parseRow(row.c);
                    if (p.id && p.fid) { // ·ªû sheet n√†y, fid t·∫°m hi·ªÉu l√† PID (ID ch·ªìng)
                        nodesMap[p.id] = { id: p.id, pids: [p.fid], name: p.name, gender: "female" };
                        if (!partnerMap[p.fid]) partnerMap[p.fid] = [];
                        partnerMap[p.fid].push(p.id);
                    }
                });

                // 2. Qu√©t Sheet huy·∫øt th·ªëng
                dataRows.forEach((row, i) => {
                    if (i === 0 || !row.c) return;
                    let p = parseRow(row.c);
                    if (p.id) {
                        nodesMap[p.id] = {
                            id: p.id,
                            fid: (p.fid && p.fid !== p.id) ? p.fid : null,
                            mid: p.mid,
                            pids: partnerMap[p.id] || [],
                            name: p.name,
                            gender: p.gender
                        };
                    }
                });

                const nodes = Object.values(nodesMap);
                log.innerHTML = `‚úÖ ƒê√£ b√≥c t√°ch th√†nh c√¥ng: ${nodes.length} ng∆∞·ªùi.`;

                if (nodes.length > 0) {
                    setTimeout(() => log.style.display = "none", 3000);
                    [attachment_0](attachment)
                    new FamilyTree(document.getElementById("tree"), {
                        template: "hugo",
                        layout: FamilyTree.layout.hierarchy,
                        nodeBinding: { field_0: "name", field_1: "id" },
                        nodes: nodes.slice(0, 195)
                    });
                } else {
                    log.innerHTML = "‚ùå L·ªñI: Sheets tr·∫£ v·ªÅ h√†ng tr·ªëng. <br>H√£y ki·ªÉm tra quy·ªÅn 'Chia s·∫ª c√¥ng khai'.";
                }

            } catch (e) {
                log.innerHTML = "‚ùå L·ªói k·∫øt n·ªëi: " + e.message;
            }
        }
        start();
    </script>
</body>
</html>
