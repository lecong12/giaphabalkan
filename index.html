<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Final</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #fdfdfd; }
        #tree { width: 100%; height: 100%; }
        #status { position: fixed; top: 10px; left: 10px; z-index: 9999; background: #333; color: #fff; padding: 15px; border-radius: 5px; font-family: Arial, sans-serif; }
        .btn-force { background: #ff4757; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; margin-top: 10px; display: block; }
    </style>
</head>
<body>
    <div id="status">
        <span id="msg">Đang đồng bộ dữ liệu từ Google Sheets...</span>
        <button id="forceBtn" class="btn-force" style="display:none" onclick="renderTree()">Bấm để hiện cây ngay</button>
    </div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
        let finalNodes = [];

        function forceGetId(val) {
            if (!val) return null;
            let s = String(val).split(','); 
            let cleanId = "";
            for (let i = 0; i < s.length; i++) {
                if (s[i] >= '0' && s[i] <= '9') cleanId += s[i];
            }
            return cleanId || null;
        }

        function forceGetName(val) {
            if (!val) return "Thành viên";
            let s = String(val);
            let parts = s.split(',');
            return parts.length > 1 ? parts.slice(1).join(',').trim() : s.trim();
        }

        async function loadData() {
            try {
                const fetchSheet = async (gid) => {
                    const res = await fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`);
                    const text = await res.text();
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    return json.table.rows.map(r => r.c ? r.c.map(cell => cell ? cell.v : null) : []);
                };

                const [dataRows, dDataRows] = await Promise.all([fetchSheet('0'), fetchSheet('1705210560')]);
                
                let nodesMap = {};
                let partnerMap = {}; 

                dDataRows.forEach((r, i) => {
                    if (i === 0 || !r) return;
                    let id = forceGetId(r), pid = forceGetId(r);
                    if (id && pid) {
                        nodesMap[id] = { id, pids: [pid], name: forceGetName(r || r), gender: "female" };
                        if (!partnerMap[pid]) partnerMap[pid] = [];
                        partnerMap[pid].push(id);
                    }
                });

                dataRows.forEach((r, i) => {
                    if (i === 0 || !r) return;
                    let id = forceGetId(r);
                    if (id) {
                        nodesMap[id] = {
                            id, 
                            fid: forceGetId(r),
                            mid: forceGetId(r),
                            pids: partnerMap[id] || [],
                            name: forceGetName(r || r),
                            gender: (String(r||"").toLowerCase().includes('nữ')) ? "female" : "male"
                        };
                    }
                });

                finalNodes = Object.values(nodesMap).slice(0, 195);
                document.getElementById("msg").innerText = `Đã sẵn sàng ${finalNodes.length} người.`;
                document.getElementById("forceBtn").style.display = "block";
                
                // Tự động vẽ sau 1 giây
                setTimeout(renderTree, 1000);

            } catch (e) {
                document.getElementById("msg").innerText = "Lỗi: " + e.message;
            }
        }

        function renderTree() {
            if (finalNodes.length === 0) return;
            document.getElementById("status").style.display = "none";
            
            new FamilyTree(document.getElementById("tree"), {
                mouseScrol: FamilyTree.action.zoom,
                template: "hugo",
                layout: FamilyTree.layout.hierarchy,
                nodeBinding: { field_0: "name", field_1: "id" },
                nodes: finalNodes
            });
        }

        loadData();
    </script>
</body>
</html>
