<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Bản Chuẩn</title>
    <script src="https://balkan.app/js/FamilyTree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f4f7f6; }
        #tree { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="tree"></div>
    <script>
        [span_0](start_span)// ID Spreadsheet mới của bạn[span_0](end_span)
        const ssId = '19ON0r9hn0Z6VcuM9oeeKyaCP863tkZlqeV3Si3v25KE';

        function clean(val) { 
            if (!val) return null;
            let res = String(val).replace(/"/g, "").trim();
            return (res === "0" || res === "") ? null : res;
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim().toLowerCase());
            return lines.slice(1).map(line => {
                const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                let obj = {};
                headers.forEach((header, i) => {
                    obj[header] = values[i] ? values[i].replace(/^"|"$/g, '').trim() : "";
                });
                return obj;
            });
        }

        async function init() {
            try {
                [span_1](start_span)// Tải dữ liệu từ sheet "Data"[span_1](end_span)
                const response = await fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&sheet=Data`);
                const csvText = await response.text();
                const data = parseCSV(csvText);

                const nodes = [];
                data.forEach(p => {
                    const id = clean(p.id);
                    if (!id) return;

                    const fid = clean(p.fid);
                    const mid = clean(p.mid);
                    const gender = (p.gender && p.gender.toLowerCase().includes('fe')) ? 'female' : 'male';

                    nodes.push({
                        id: id,
                        fid: fid,
                        mid: mid,
                        name: p.full_name || "Vô danh",
                        gender: gender,
                        address: p.adress,
                        notes: p.notes
                    });
                });

                const family = new FamilyTree(document.getElementById("tree"), {
                    template: "tommy",
                    nodeBinding: {
                        field_0: "name",
                        field_1: "address"
                    },
                    enableSearch: true,
                    mouseWheel: { zoom: true },
                    // Layout thông minh tự động kết nối các nút
                    layout: FamilyTree.mixed,
                    nodes: nodes
                });

                // Tự động tìm cụ tổ (thường là ID 1) để lấy làm tâm điểm
                family.on('init', () => { family.fit(); });

            } catch (error) {
                console.error("Lỗi tải dữ liệu:", error);
                document.getElementById('tree').innerHTML = "<p style='padding:20px;'>Không thể tải dữ liệu. Vui lòng kiểm tra quyền chia sẻ của File Google Sheets.</p>";
            }
        }

        init();
    </script>
</body>
</html>
