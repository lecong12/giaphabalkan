<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công</title>
    <script src="https://balkan.app/js/FamilyTree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f4f7f6; }
        #tree { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="tree"></div>
    <script>
        const ssId = '1mX5C3YiDKb-R1Igweo10NsxCtmxIrG2hlCZM5OlPXEw';

        function parseCSV(text) {
            const lines = text.split('\n');
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim().toLowerCase());
            return lines.slice(1).map(line => {
                const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                let obj = {};
                headers.forEach((header, i) => {
                    let val = values[i] || "";
                    obj[header] = val.replace(/^"|"$/g, '').trim();
                });
                return obj;
            });
        }

        async function init() {
            try {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&sheet=Data`);
                const text = await res.text();
                const rawData = parseCSV(text);

                const nodes = rawData.map(p => {
                    if (!p.id) return null;
                    
                    // Logic kết nối: Gom cha (fid) và mẹ (mid) lại để vẽ nhánh
                    let pids = [];
                    if (p.fid) pids.push(p.fid);
                    if (p.mid) pids.push(p.mid);

                    return {
                        id: p.id,
                        pids: pids.length > 0 ? pids : null,
                        name: p.full_name || "Thành viên " + p.id,
                        gender: (p.gender && p.gender.toLowerCase().includes('fe')) ? 'female' : 'male'
                    };
                }).filter(n => n !== null);

                new FamilyTree(document.getElementById("tree"), {
                    template: "tommy",
                    nodeBinding: { field_0: "name" },
                    nodes: nodes
                });
            } catch (e) {
                console.error(e);
            }
        }
        init();
    </script>
</body>
</html>
