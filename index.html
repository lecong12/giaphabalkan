<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công</title>
    <script src="https://balkan.app/js/FamilyTree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f4f7f6; }
        #tree { width: 100%; height: 100%; }
        #msg { position: fixed; top: 20px; left: 20px; z-index: 100; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-family: sans-serif; }
    </script>
</head>
<body>
    <div id="msg">Đang đồng bộ dữ liệu gia phả...</div>
    <div id="tree"></div>
    <script>
        const ssId = '1mX5C3YiDKb-R1Igweo10NsxCtmxIrG2hlCZM5OlPXEw';

        // Hàm dọn dẹp dữ liệu cực mạnh
        function clean(str) {
            if (!str) return "";
            return String(str).replace(/"/g, "").replace(/\s+/g, " ").trim();
        }

        async function fetchCSV(sheetName) {
            const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
            const response = await fetch(url);
            const text = await response.text();
            
            const rows = FamilyTree.csv.parse(text);
            // Chuẩn hóa tên cột: bỏ dấu ngoặc, viết thường
            return rows.map(row => {
                const newRow = {};
                for (let key in row) {
                    const cleanKey = key.replace(/"/g, "").toLowerCase().trim();
                    newRow[cleanKey] = row[key];
                }
                return newRow;
            });
        }

        async function init() {
            try {
                const [dataMain, dataSpouses] = await Promise.all([
                    fetchCSV('Data'),
                    fetchCSV('dData')
                ]);

                const partnerMap = {};
                dataSpouses.forEach(s => {
                    const hId = clean(s.pid || s.pids);
                    const wId = clean(s.id);
                    if (hId && wId) { partnerMap[hId] = wId; partnerMap[wId] = hId; }
                });

                const finalData = [];
                dataMain.forEach(p => {
                    const id = clean(p.id);
                    if (!id || id.toLowerCase() === "id") return;
                    
                    const fid = clean(p.fid);
                    const mid = partnerMap[fid] || "";
                    
                    finalData.push({
                        id: id,
                        name: clean(p.full_name || p.name),
                        pids: (fid && mid) ? [fid, mid] : (fid ? [fid] : null),
                        gender: clean(p.gender).toLowerCase().includes('fe') ? 'female' : 'male'
                    });
                });

                dataSpouses.forEach(s => {
                    const id = clean(s.id);
                    if (!id || id.toLowerCase() === "id") return;
                    finalData.push({
                        id: id,
                        name: clean(s.full_name || s.name),
                        partnerId: clean(s.pid),
                        gender: 'female'
                    });
                });

                document.getElementById('msg').style.display = 'none';

                new FamilyTree(document.getElementById("tree"), {
                    template: "tommy",
                    nodeBinding: { field_0: "name" },
                    nodes: finalData
                });
            } catch (e) {
                document.getElementById('msg').innerHTML = "Lỗi: Không thể đọc Sheet. Hãy kiểm tra tab 'Data' và 'dData'.";
            }
        }
        init();
    </script>
</body>
</html>
