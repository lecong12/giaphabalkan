<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Bản Sửa Lỗi Biến</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #ffffff; }
        #tree { width: 100%; height: 100%; position: absolute; }
        #loading { position: fixed; top: 10px; left: 10px; z-index: 999; background: #333; color: #fff; padding: 10px 20px; border-radius: 5px; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="loading">Hệ thống đang nạp dữ liệu...</div>
    <div id="tree"></div>

    <script>
        const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';

        // Hàm xử lý an toàn tuyệt đối, không dùng biến lạ
        function getSafeStr(cell) {
            if (!cell) return "";
            return String(cell.f || cell.v || "").trim();
        }

        function extractNumber(str) {
            if (!str) return null;
            var match = str.split(',').match(/\d+/);
            return match ? match : null;
        }

        async function start() {
            try {
                const fetchSheet = async (gid) => {
                    const response = await fetch(`https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`);
                    const text = await response.text();
                    const json = JSON.parse(text.substring(47, text.length - 2));
                    return json.table.rows;
                };

                const [dataRows, dDataRows] = await Promise.all([fetchSheet('0'), fetchSheet('1705210560')]);
                
                var nodes = [];
                var partners = {};

                // 1. Đọc Sheet phối ngẫu (dData)
                dDataRows.forEach(function(row) {
                    if (!row.c) return;
                    var rawId = getSafeStr(row.c);
                    var rawPid = getSafeStr(row.c);
                    var id = extractNumber(rawId);
                    var pid = extractNumber(rawPid);
                    
                    if (id && pid) {
                        nodes.push({ id: id, pids: [pid], name: rawId.split(',') || rawId, gender: "female" });
                        if (!partners[pid]) partners[pid] = [];
                        partners[pid].push(id);
                    }
                });

                // 2. Đọc Sheet huyết thống (Data)
                dataRows.forEach(function(row, i) {
                    if (i === 0 || !row.c) return;
                    var rawId = getSafeStr(row.c);
                    var id = extractNumber(rawId);
                    
                    if (id) {
                        nodes.push({
                            id: id,
                            fid: extractNumber(getSafeStr(row.c)),
                            mid: extractNumber(getSafeStr(row.c)),
                            pids: partners[id] || [],
                            name: getSafeStr(row.c) || rawId.split(',') || rawId,
                            gender: getSafeStr(row.c).toLowerCase().includes('nữ') ? "female" : "male"
                        });
                    }
                });

                document.getElementById("loading").style.display = "none";

                if (nodes.length > 0) {
                    [attachment_0](attachment)
                    var family = new FamilyTree(document.getElementById("tree"), {
                        template: "hugo",
                        layout: FamilyTree.layout.hierarchy,
                        nodeBinding: {
                            field_0: "name",
                            field_1: "id"
                        },
                        nodes: nodes.slice(0, 195)
                    });
                } else {
                    document.getElementById("loading").innerText = "Không có dữ liệu hợp lệ!";
                }

            } catch (e) {
                document.getElementById("loading").innerText = "Lỗi: " + e.message;
            }
        }
        start();
    </script>
</body>
</html>
