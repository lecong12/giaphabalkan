<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - Cập Nhật Trực Tuyến</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #ffffff; }
        #tree { width: 100%; height: 100%; }
        .bft-license-message { display: none !important; }
        #status { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 10px; border-radius: 5px; z-index: 1000; font-family: sans-serif; }
    </style>
</head>
<body>

<div id="status">Đang đồng bộ với Google Sheets...</div>
<div id="tree"></div>

<script>
    const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';
    
    // Hàm nạp dữ liệu từ từng Sheet
    async function getSheetData(gid) {
        const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
        const res = await fetch(url);
        const text = await res.text();
        // Xử lý chuỗi JSON đặc thù của Google
        const json = JSON.parse(text.substr(47).slice(0, -2));
        const rows = json.table.rows;
        const cols = json.table.cols.map(c => c.label.toLowerCase().trim());

        return rows.map(row => {
            let obj = {};
            row.c.forEach((cell, i) => {
                if (cols[i]) obj[cols[i]] = cell ? cell.v : null;
            });
            return obj;
        });
    }

    async function init() {
        try {
            // Nạp Data (gid=0) và dData (gid=1705210560)
            const [data, dData] = await Promise.all([getSheetData(0), getSheetData(1705210560)]);
            
            // Xử lý mối quan hệ vợ chồng (pids)
            let partners = {};
            dData.forEach(s => {
                if (s.pid) {
                    const pid = String(s.pid);
                    if (!partners[pid]) partners[pid] = [];
                    partners[pid].push(String(s.id));
                }
            });

            // Gộp tất cả thành Node của Balkan
            const nodes = [
                ...data.map(m => ({
                    id: String(m.id),
                    fid: m.fid ? String(m.fid) : null,
                    mid: m.mid ? String(m.mid) : null,
                    pids: partners[String(m.id)] || [],
                    name: m.full_name || "Vô danh",
                    gender: (m.gender || "").toLowerCase().includes('f') ? "female" : "male"
                })),
                ...dData.map(s => ({
                    id: String(s.id),
                    pids: [String(s.pid)],
                    name: s.full_name || "Vô danh",
                    gender: (s.gender || "").toLowerCase().includes('f') ? "female" : "male"
                }))
            ].filter(n => n.id !== "null");

            document.getElementById('status').style.display = 'none';

            new FamilyTree(document.getElementById("tree"), {
                template: "hugo",
                nodeBinding: { field_0: "name" },
                nodes: nodes
            });

        } catch (e) {
            document.getElementById('status').innerText = "Lỗi: Hãy kiểm tra tên cột trên Sheets!";
            console.error(e);
        }
    }

    init();
</script>
</body>
</html>
