<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gia Phả Lê Công - V89</title>
    <script src="https://balkan.app/js/familytree.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #fff; }
        #tree { width: 100%; height: 100%; }
        .bft-license-message { display: none !important; }
    </style>
</head>
<body>
<div id="tree"></div>
<script>
    const ssId = '1KgxSyIETIPPO7P_tBUcK7bRO4Ej4b863A-skdMHLMYM';

    async function getSheet(gid) {
        const url = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json&gid=${gid}`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        const cols = json.table.cols.map(c => (c.label || "").toLowerCase().trim());
        return json.table.rows.map(row => {
            let obj = {};
            row.c.forEach((cell, i) => { if (cols[i]) obj[cols[i]] = cell ? cell.v : null; });
            return obj;
        });
    }

    async function init() {
        try {
            // Tải dữ liệu từ 2 Sheet
            const [data, dData] = await Promise.all([getSheet(0), getSheet(1705210560)]);

            // 1. Tạo danh sách vợ chồng từ dData
            let spouseMap = {}; 
            dData.forEach(s => {
                const partnerId = s.pid ? String(s.pid).trim() : null;
                const myId = s.id ? String(s.id).trim() : null;
                if (partnerId && myId) {
                    if (!spouseMap[partnerId]) spouseMap[partnerId] = [];
                    spouseMap[partnerId].push(myId);
                }
            });

            // 2. Xử lý thành viên gốc (Sheet Data)
            const membersNodes = data.map(m => {
                const id = String(m.id).trim();
                return {
                    id: id,
                    fid: m.fid ? String(m.fid).trim() : null,
                    mid: m.mid ? String(m.mid).trim() : null,
                    pids: spouseMap[id] || [], // Lấy vợ/chồng từ map đã tạo
                    name: m.full_name || "Vô danh",
                    gender: (m.gender || "").toLowerCase().includes('f') ? "female" : "male"
                };
            });

            // 3. Xử lý thành viên phụ (Sheet dData)
            const spousesNodes = dData.map(s => {
                const id = String(s.id).trim();
                const partnerId = s.pid ? String(s.pid).trim() : null;
                return {
                    id: id,
                    pids: partnerId ? [partnerId] : [],
                    name: s.full_name || "Vô danh",
                    gender: (s.gender || "").toLowerCase().includes('f') ? "female" : "male"
                };
            });

            const allNodes = [...membersNodes, ...spousesNodes].filter(n => n.id !== "null");

            new FamilyTree(document.getElementById("tree"), {
                template: "hugo",
                nodeBinding: { field_0: "name" },
                nodes: allNodes
            });
        } catch (e) { console.error("Lỗi kết nối:", e); }
    }
    init();
</script>
</body>
</html>
